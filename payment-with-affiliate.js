const BACKEND_URL='https://kainow-saude-production.up.railway.app';async function criarCobrancaComAfiliado(e){try{console.log("üöÄ Iniciando cria√ß√£o de cobran√ßa...");const a=KaiNowAffiliate.getSavedAffiliate();if(!a||!a.id)return void alert("‚ö†Ô∏è Nenhum afiliado detectado.");console.log("‚úÖ Afiliado detectado:",a.id),mostrarLoading("Gerando c√≥digo PIX...");const o=await fetch(`${BACKEND_URL}/api/affiliates/${a.id}`);if(!o.ok)throw new Error("Afiliado n√£o encontrado");const t=await o.json();console.log("‚úÖ Dados do afiliado carregados");const n={productId:e.id,value:e.value,affiliateId:a.id,customerName:"",customerEmail:"",customerPhone:""};console.log("üì§ Criando cobran√ßa na Woovi...");const r=await fetch(`${BACKEND_URL}/api/charges/create-with-split`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!r.ok){const e=await r.json();throw new Error(e.message||"Erro ao criar cobran√ßa")}const i=await r.json();console.log("‚úÖ Cobran√ßa criada com sucesso!"),console.log("Split:",i.charge.split),localStorage.setItem("kainow_current_charge",JSON.stringify({chargeId:i.charge.id,productId:e.id,productName:e.name,value:e.value,qrCode:i.charge.qrCode,qrCodeText:i.charge.qrCodeText,paymentLink:i.charge.paymentLink,affiliateId:a.id,affiliateName:t.name||a.id,createdAt:(new Date).toISOString(),expiresAt:i.charge.expiresAt})),esconderLoading(),window.location.href="/pagamento-pix.html"}catch(e){console.error("‚ùå Erro ao criar cobran√ßa:",e),esconderLoading(),alert("‚ùå Erro: "+e.message)}}function mostrarLoading(e){esconderLoading();const a=`\n        <div id="kainow-payment-loading" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:99999">\n            <div style="background:white;padding:40px;border-radius:12px;text-align:center">\n                <div style="width:50px;height:50px;border:4px solid #f3f3f3;border-top:4px solid #1e40af;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px"></div>\n                <p style="margin:0;font-size:18px;color:#333;font-weight:600">${e}</p>\n            </div>\n        </div>\n        <style>@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}</style>\n    `;document.body.insertAdjacentHTML("beforeend",a)}function esconderLoading(){const e=document.getElementById("kainow-payment-loading");e&&e.remove()}function inicializarPagamentoAfiliado(){console.log("üí≥ Sistema de pagamento com afiliado inicializado");const e=KaiNowAffiliate.getSavedAffiliate();e&&e.id&&console.log("‚úÖ Afiliado ativo:",e.id)}window.criarCobrancaComAfiliado=criarCobrancaComAfiliado,window.mostrarLoading=mostrarLoading,window.esconderLoading=esconderLoading,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",inicializarPagamentoAfiliado):inicializarPagamentoAfiliado(),console.log("‚úÖ Sistema de pagamento com afiliado carregado"),console.log("‚úÖ Fun√ß√£o criarCobrancaComAfiliado() dispon√≠vel globalmente");
