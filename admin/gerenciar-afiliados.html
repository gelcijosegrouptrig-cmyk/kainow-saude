 1	<!DOCTYPE html>
     2	<html lang="pt-BR">
     3	<head>
     4	    <meta charset="UTF-8">
     5	    <meta name="viewport" content="width=device-width, initial-scale=1.0">
     6	    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
     7	    <meta http-equiv="Pragma" content="no-cache">
     8	    <meta http-equiv="Expires" content="0">
     9	    <title>Gerenciador de Afiliados - KaiNow Admin v3.0</title>
    10	    <script src="https://cdn.tailwindcss.com"></script>
    11	    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    12	    
    13	    <!-- Firebase SDKs -->
    14	    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    15	    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    16	    
    17	    <script>
    18	        tailwind.config = {
    19	            theme: {
    20	                extend: {
    21	                    colors: {
    22	                        primary: '#0066CC',
    23	                        secondary: '#00A8E8',
    24	                    }
    25	                }
    26	            }
    27	        }
    28	    </script>
    29	</head>
    30	<body class="bg-gray-50">
    31	    <!-- Header -->
    32	    <header class="bg-white shadow-lg border-b-4 border-blue-500">
    33	        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
    34	            <div class="flex items-center space-x-4">
    35	                <button onclick="window.location.href='dashboard-admin.html'" class="text-gray-600 hover:text-gray-800">
    36	                    <i class="fas fa-arrow-left text-xl"></i>
    37	                </button>
    38	                <div>
    39	                    <h1 class="text-2xl font-bold text-gray-800">Gerenciar Afiliados</h1>
    40	                    <p class="text-sm text-gray-600">Criar afiliados e gerar links</p>
    41	                </div>
    42	            </div>
    43	            
    44	            <button 
    45	                onclick="logout()"
    46	                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition"
    47	            >
    48	                <i class="fas fa-sign-out-alt mr-2"></i>
    49	                Sair
    50	            </button>
    51	        </div>
    52	    </header>
    53	
    54	    <div class="container mx-auto px-4 py-8">
    55	        <!-- T√≠tulo -->
    56	        <div class="mb-8">
    57	            <div class="flex justify-between items-center">
    58	                <div>
    59	                    <h2 class="text-3xl font-bold text-gray-800 mb-2">
    60	                        <i class="fas fa-users-cog text-primary mr-3"></i>
    61	                        Gerenciador de Afiliados
    62	                        <span class="text-sm bg-green-500 text-white px-2 py-1 rounded ml-2">v3.0</span>
    63	                    </h2>
    64	                    <p class="text-gray-600">Crie divulgadores, gere links e gerencie comiss√µes</p>
    65	                </div>
    66	                <button 
    67	                    onclick="location.reload(true)"
    68	                    class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition"
    69	                >
    70	                    <i class="fas fa-sync-alt mr-2"></i>
    71	                    For√ßar Atualiza√ß√£o
    72	                </button>
    73	            </div>
    74	        </div>
    75	
    76	        <!-- Cards Estat√≠sticas -->
    77	        <div class="grid md:grid-cols-4 gap-6 mb-8">
    78	            <div class="bg-white rounded-xl shadow-lg p-6">
    79	                <div class="flex items-center justify-between">
    80	                    <div>
    81	                        <p class="text-gray-600 text-sm">Total Afiliados</p>
    82	                        <h3 class="text-3xl font-bold text-primary" id="total-affiliates">0</h3>
    83	                    </div>
    84	                    <i class="fas fa-users text-4xl text-primary opacity-20"></i>
    85	                </div>
    86	            </div>
    87	            
    88	            <div class="bg-white rounded-xl shadow-lg p-6">
    89	                <div class="flex items-center justify-between">
    90	                    <div>
    91	                        <p class="text-gray-600 text-sm">Links Gerados</p>
    92	                        <h3 class="text-3xl font-bold text-green-600" id="total-links">0</h3>
    93	                    </div>
    94	                    <i class="fas fa-link text-4xl text-green-600 opacity-20"></i>
    95	                </div>
    96	            </div>
    97	            
    98	            <div class="bg-white rounded-xl shadow-lg p-6">
    99	                <div class="flex items-center justify-between">
   100	                    <div>
   101	                        <p class="text-gray-600 text-sm">Comiss√£o Padr√£o</p>
   102	                        <h3 class="text-3xl font-bold text-amber-600">20%</h3>
   103	                    </div>
   104	                    <i class="fas fa-percentage text-4xl text-amber-600 opacity-20"></i>
   105	                </div>
   106	            </div>
   107	            
   108	            <div class="bg-white rounded-xl shadow-lg p-6">
   109	                <div class="flex items-center justify-between">
   110	                    <div>
   111	                        <p class="text-gray-600 text-sm">Plataforma</p>
   112	                        <h3 class="text-3xl font-bold text-purple-600">80%</h3>
   113	                    </div>
   114	                    <i class="fas fa-building text-4xl text-purple-600 opacity-20"></i>
   115	                </div>
   116	            </div>
   117	        </div>
   118	
   119	        <!-- Bot√£o Novo Afiliado -->
   120	        <div class="mb-6">
   121	            <button onclick="openNewAffiliateModal()" class="bg-gradient-to-r from-primary to-secondary text-white px-6 py-3 rounded-lg font-bold hover:shadow-xl transition">
   122	                <i class="fas fa-user-plus mr-2"></i>
   123	                Novo Divulgador
   124	            </button>
   125	        </div>
   126	
   127	        <!-- Lista de Afiliados -->
   128	        <div class="bg-white rounded-xl shadow-lg p-6">
   129	            <h3 class="text-xl font-bold text-gray-800 mb-6">
   130	                <i class="fas fa-list mr-2"></i>
   131	                Divulgadores Cadastrados
   132	            </h3>
   133	            <div id="affiliates-list" class="space-y-4">
   134	                <!-- Afiliados ser√£o listados aqui -->
   135	            </div>
   136	        </div>
   137	    </div>
   138	
   139	    <!-- Modal: Novo Afiliado -->
   140	    <div id="new-affiliate-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
   141	        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[85vh] overflow-y-auto p-6">
   142	            <div class="flex justify-between items-center mb-4">
   143	                <h3 class="text-xl font-bold text-gray-800">
   144	                    <i class="fas fa-user-plus text-primary mr-2"></i>
   145	                    Novo Divulgador
   146	                </h3>
   147	                <button onclick="closeNewAffiliateModal()" class="text-gray-500 hover:text-gray-700">
   148	                    <i class="fas fa-times text-xl"></i>
   149	                </button>
   150	            </div>
   151	
   152	            <form id="affiliate-form" class="space-y-3">
   153	                <div>
   154	                    <label class="block text-xs font-bold text-gray-700 mb-1">Nome do Divulgador</label>
   155	                    <input type="text" id="affiliate-name" required class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-primary focus:outline-none text-sm">
   156	                </div>
   157	
   158	                <div>
   159	                    <label class="block text-xs font-bold text-gray-700 mb-1">Email</label>
   160	                    <input type="email" id="affiliate-email" required class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-primary focus:outline-none text-sm">
   161	                </div>
   162	
   163	                <div>
   164	                    <label class="block text-xs font-bold text-gray-700 mb-1">Telefone/WhatsApp</label>
   165	                    <input type="tel" id="affiliate-phone" required class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-primary focus:outline-none text-sm" placeholder="(00) 00000-0000">
   166	                </div>
   167	
   168	                <div class="bg-green-50 border border-green-300 rounded-lg p-3">
   169	                    <label class="block text-xs font-bold text-gray-700 mb-1">
   170	                        <i class="fab fa-pix text-green-600 mr-1"></i>
   171	                        Chave PIX
   172	                    </label>
   173	                    <select id="affiliate-pix-type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-primary focus:outline-none mb-2 text-sm">
   174	                        <option value="cpf">CPF</option>
   175	                        <option value="cnpj">CNPJ</option>
   176	                        <option value="email">Email</option>
   177	                        <option value="telefone">Telefone</option>
   178	                        <option value="aleatoria">Chave Aleat√≥ria</option>
   179	                    </select>
   180	                    <input type="text" id="affiliate-pix" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-primary focus:outline-none text-sm" placeholder="Digite a chave PIX">
   181	                    <p class="text-xs text-gray-600 mt-1">
   182	                        <i class="fas fa-info-circle mr-1"></i>
   183	                        Comiss√µes via esta chave
   184	                    </p>
   185	                </div>
   186	
   187	                <div class="bg-blue-50 border border-blue-300 rounded-lg p-3">
   188	                    <label class="block text-xs font-bold text-gray-700 mb-1">
   189	                        <i class="fas fa-link text-blue-600 mr-1"></i>
   190	                        Nome/Apelido no Link (Opcional)
   191	                    </label>
   192	                    <input 
   193	                        type="text" 
   194	                        id="affiliate-slug" 
   195	                        placeholder="Ex: joaosilva"
   196	                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-primary focus:outline-none text-sm"
   197	                        pattern="[a-z0-9-]+"
   198	                        maxlength="30"
   199	                    >
   200	                    <p class="text-xs text-gray-600 mt-1">
   201	                        <i class="fas fa-info-circle mr-1"></i>
   202	                        Apenas letras min√∫sculas, n√∫meros e h√≠fen. Deixe vazio para gerar automaticamente.
   203	                    </p>
   204	                    <p class="text-xs text-blue-600 mt-1">
   205	                        Ex: ...?ref=<span id="slug-preview">joaosilva</span>
   206	                    </p>
   207	                </div>
   208	
   209	                <div>
   210	                    <label class="block text-xs font-bold text-gray-700 mb-1">Comiss√£o (%)</label>
   211	                    <input type="number" id="affiliate-commission" value="20" min="0" max="100" required class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-primary focus:outline-none text-sm">
   212	                    <p class="text-xs text-gray-500 mt-1">Padr√£o: 20% para divulgador, 80% para plataforma</p>
   213	                </div>
   214	
   215	                <button type="submit" class="w-full bg-gradient-to-r from-primary to-secondary text-white px-4 py-3 rounded-lg font-bold hover:shadow-xl transition text-sm">
   216	                    <i class="fas fa-save mr-2"></i>
   217	                    Criar Divulgador
   218	                </button>
   219	            </form>
   220	        </div>
   221	    </div>
   222	
   223	    <!-- Modal: Links do Afiliado -->
   224	    <div id="affiliate-links-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
   225	        <div class="bg-white rounded-2xl max-w-3xl w-full max-h-[85vh] overflow-y-auto p-6">
   226	            <div class="flex justify-between items-center mb-4">
   227	                <h3 class="text-xl font-bold text-gray-800">
   228	                    <i class="fas fa-link text-primary mr-2"></i>
   229	                    Links de Divulga√ß√£o
   230	                </h3>
   231	                <button onclick="closeLinksModal()" class="text-gray-500 hover:text-gray-700">
   232	                    <i class="fas fa-times text-xl"></i>
   233	                </button>
   234	            </div>
   235	
   236	            <div id="affiliate-info" class="bg-gradient-to-r from-primary to-secondary text-white p-4 rounded-xl mb-4">
   237	                <!-- Informa√ß√µes do afiliado -->
   238	            </div>
   239	
   240	            <div id="products-links" class="space-y-3">
   241	                <!-- Links dos produtos -->
   242	            </div>
   243	        </div>
   244	    </div>
   245	
   246	    <!-- Modal Ver Login -->
   247	    <div id="login-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
   248	        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[85vh] overflow-y-auto p-6">
   249	            <div class="flex justify-between items-center mb-4">
   250	                <h3 class="text-xl font-bold text-gray-800">
   251	                    <i class="fas fa-key text-blue-600 mr-2"></i>
   252	                    Credenciais de Acesso
   253	                </h3>
   254	                <button onclick="closeLoginModal()" class="text-gray-500 hover:text-gray-700">
   255	                    <i class="fas fa-times text-xl"></i>
   256	                </button>
   257	            </div>
   258	
   259	            <div id="login-info" class="space-y-4">
   260	                <!-- Informa√ß√µes ser√£o inseridas aqui -->
   261	            </div>
   262	
   263	            <div class="mt-4 flex space-x-2">
   264	                <button 
   265	                    onclick="copyLoginCredentials()"
   266	                    class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded-lg transition text-sm"
   267	                >
   268	                    <i class="fas fa-copy mr-1"></i>
   269	                    Copiar
   270	                </button>
   271	                <button 
   272	                    onclick="sendWhatsApp()"
   273	                    class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg transition text-sm"
   274	                >
   275	                    <i class="fab fa-whatsapp mr-1"></i>
   276	                    WhatsApp
   277	                </button>
   278	                <button 
   279	                    onclick="closeLoginModal()"
   280	                    class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition text-sm"
   281	                >
   282	                    Fechar
   283	                </button>
   284	            </div>
   285	        </div>
   286	    </div>
   287	
   288	    <script>
   289	        // Dados dos produtos
   290	        const products = [
   291	            { id: 'mulher', name: 'KaiNow Mulher', price: '49,90', color: 'pink', icon: 'fa-venus' },
   292	            { id: 'senior', name: 'KaiNow S√™nior', price: '59,90', color: 'amber', icon: 'fa-user-shield' },
   293	            { id: 'farma', name: 'KaiNow Farma', price: '19,90', color: 'green', icon: 'fa-pills' },
   294	            { id: 'acolher', name: 'KaiNow Acolher', price: '24,90', color: 'blue', icon: 'fa-hands-holding-child' },
   295	            { id: 'orienta', name: 'KaiNow Orienta', price: '19,90', color: 'purple', icon: 'fa-lightbulb' },
   296	            { id: 'vivaleve', name: 'KaiNow Viva Leve', price: '24,90', color: 'teal', icon: 'fa-spa' }
   297	        ];
   298	
   299	        // Configura√ß√£o Firebase
   300	        const firebaseConfig = {
   301	            apiKey: "AIzaSyA2-tCGH1uaABTzMqhK_BhTy-zIZba0wMs",
   302	            authDomain: "kainowsaude.firebaseapp.com",
   303	            projectId: "kainowsaude",
   304	            storageBucket: "kainowsaude.firebasestorage.app",
   305	            messagingSenderId: "230049250523",
   306	            appId: "1:230049250523:web:ce16ada5c4e5488e64e0fe"
   307	        };
   308	
   309	        firebase.initializeApp(firebaseConfig);
   310	        const db = firebase.firestore();
   311	        console.log('üî• Firebase inicializado');
   312	
   313	        // Carregar afiliados do Firestore
   314	        async function loadAffiliates() {
   315	            try {
   316	                console.log('üì° Carregando afiliados do Firestore...');
   317	                const snapshot = await db.collection('affiliates').get();
   318	                
   319	                const affiliates = snapshot.docs.map(doc => ({
   320	                    id: doc.id,
   321	                    ...doc.data()
   322	                }));
   323	                
   324	                console.log(`‚úÖ ${affiliates.length} afiliados carregados`);
   325	                return affiliates;
   326	            } catch (error) {
   327	                console.error('‚ùå Erro ao carregar afiliados:', error);
   328	                return [];
   329	            }
   330	        }
   331	
   332	        // DEPRECATED: N√£o usar mais - agora usa Firestore
   333	        function saveAffiliates(affiliates) {
   334	            console.warn('‚ö†Ô∏è saveAffiliates() est√° obsoleta. Use Firestore diretamente.');
   335	        }
   336	
   337	        // Atualizar estat√≠sticas
   338	        async function updateStats() {
   339	            const affiliates = await loadAffiliates();
   340	            document.getElementById('total-affiliates').textContent = affiliates.length;
   341	            document.getElementById('total-links').textContent = affiliates.length * products.length;
   342	        }
   343	
   344	        // Renderizar lista de afiliados
   345	        async function renderAffiliates() {
   346	            const affiliates = await loadAffiliates();
   347	            const container = document.getElementById('affiliates-list');
   348	
   349	            if (affiliates.length === 0) {
   350	                container.innerHTML = `
   351	                    <div class="text-center py-12 text-gray-500">
   352	                        <i class="fas fa-users text-6xl mb-4 opacity-20"></i>
   353	                        <p class="text-lg">Nenhum divulgador cadastrado ainda</p>
   354	                        <button onclick="openNewAffiliateModal()" class="mt-4 text-primary hover:underline">
   355	                            <i class="fas fa-plus mr-2"></i>Cadastrar primeiro divulgador
   356	                        </button>
   357	                    </div>
   358	                `;
   359	                return;
   360	            }
   361	
   362	            container.innerHTML = affiliates.map(affiliate => `
   363	                <div class="border-2 border-gray-200 rounded-xl p-6 hover:border-primary transition">
   364	                    <div class="flex justify-between items-start">
   365	                        <div class="flex items-start space-x-4">
   366	                            <div class="bg-gradient-to-br from-primary to-secondary rounded-full w-16 h-16 flex items-center justify-center text-white text-2xl font-bold">
   367	                                ${affiliate.name.charAt(0).toUpperCase()}
   368	                            </div>
   369	                            <div>
   370	                                <h4 class="text-xl font-bold text-gray-800">${affiliate.name}</h4>
   371	                                <p class="text-gray-600"><i class="fas fa-envelope mr-2"></i>${affiliate.email}</p>
   372	                                <p class="text-gray-600"><i class="fas fa-phone mr-2"></i>${affiliate.phone}</p>
   373	                                ${affiliate.pixKey ? `
   374	                                <p class="text-green-600 font-semibold mt-1">
   375	                                    <i class="fab fa-pix mr-2"></i>PIX: ${affiliate.pixKey}
   376	                                    <span class="text-xs text-gray-500">(${affiliate.pixType})</span>
   377	                                </p>
   378	                                ` : ''}
   379	                                <div class="mt-2">
   380	                                    <span class="inline-block bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-bold">
   381	                                        <i class="fas fa-percentage mr-1"></i>${affiliate.commission}% comiss√£o
   382	                                    </span>
   383	                                    ${affiliate.slug ? `
   384	                                    <span class="inline-block bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm font-bold ml-2">
   385	                                        <i class="fas fa-link mr-1"></i>ref=${affiliate.slug}
   386	                                    </span>
   387	                                    ` : `
   388	                                    <span class="inline-block bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm font-bold ml-2">
   389	                                        ID: ${affiliate.id}
   390	                                    </span>
   391	                                    `}
   392	                                </div>
   393	                            </div>
   394	                        </div>
   395	                        <div class="flex flex-col gap-2">
   396	                            <button onclick="showLogin('${affiliate.id}')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-opacity-90 transition">
   397	                                <i class="fas fa-key mr-2"></i>Ver Login
   398	                            </button>
   399	                            <button onclick="showLinks('${affiliate.id}')" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-opacity-90 transition">
   400	                                <i class="fas fa-link mr-2"></i>Ver Links
   401	                            </button>
   402	                            <button onclick="editCommission('${affiliate.id}')" class="bg-amber-500 text-white px-4 py-2 rounded-lg hover:bg-opacity-90 transition">
   403	                                <i class="fas fa-edit mr-2"></i>Editar
   404	                            </button>
   405	                            <button onclick="deleteAffiliate('${affiliate.id}')" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-opacity-90 transition">
   406	                                <i class="fas fa-trash mr-2"></i>Excluir
   407	                            </button>
   408	                        </div>
   409	                    </div>
   410	                </div>
   411	            `).join('');
   412	        }
   413	
   414	        // Abrir modal de novo afiliado
   415	        function openNewAffiliateModal() {
   416	            document.getElementById('new-affiliate-modal').classList.remove('hidden');
   417	        }
   418	
   419	        // Fechar modal de novo afiliado
   420	        function closeNewAffiliateModal() {
   421	            document.getElementById('new-affiliate-modal').classList.add('hidden');
   422	            document.getElementById('affiliate-form').reset();
   423	        }
   424	
   425	        // Criar novo afiliado - C√ìDIGO CORRIGIDO
   426	        document.getElementById('affiliate-form').addEventListener('submit', async function(e) {
   427	            e.preventDefault();
   428	            console.log('üöÄ Formul√°rio submetido!');
   429	
   430	            const name = document.getElementById('affiliate-name').value;
   431	            const email = document.getElementById('affiliate-email').value;
   432	            const phone = document.getElementById('affiliate-phone').value;
   433	            const pixType = document.getElementById('affiliate-pix-type').value;
   434	            const pixKey = document.getElementById('affiliate-pix').value;
   435	            const commission = parseInt(document.getElementById('affiliate-commission').value);
   436	            let slug = document.getElementById('affiliate-slug').value.toLowerCase().trim();
   437	
   438	            console.log('üìù Dados do formul√°rio:', { name, email, phone, pixKey, commission });
   439	
   440	            const submitButton = e.target.querySelector('button[type="submit"]');
   441	            submitButton.disabled = true;
   442	            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Criando...';
   443	
   444	            try {
   445	                console.log('üîÑ Carregando afiliados...');
   446	                const affiliates = await loadAffiliates();
   447	                console.log('‚úÖ Afiliados carregados:', affiliates.length);
   448	
   449	                if (slug) {
   450	                    slug = slug.replace(/[^a-z0-9-]/g, '');
   451	                    if (affiliates.some(a => a.slug === slug)) {
   452	                        alert('‚ùå Este nome/apelido j√° est√° em uso! Escolha outro.');
   453	                        submitButton.disabled = false;
   454	                        submitButton.innerHTML = '<i class="fas fa-save mr-2"></i> Criar Divulgador';
   455	                        return;
   456	                    }
   457	                } else {
   458	                    slug = name.toLowerCase()
   459	                        .normalize('NFD')
   460	                        .replace(/[\u0300-\u036f]/g, '')
   461	                        .replace(/[^a-z0-9\s-]/g, '')
   462	                        .replace(/\s+/g, '-')
   463	                        .substring(0, 30);
   464	                    
   465	                    let slugCounter = 1;
   466	                    let finalSlug = slug;
   467	                    while (affiliates.some(a => a.slug === finalSlug)) {
   468	                        finalSlug = slug + slugCounter;
   469	                        slugCounter++;
   470	                    }
   471	                    slug = finalSlug;
   472	                }
   473	
   474	                const username = email.split('@')[0].toLowerCase().replace(/[^a-z0-9]/g, '');
   475	                const defaultPassword = 'kainow' + Math.random().toString(36).slice(-6);
   476	                
   477	                const affiliate = {
   478	                    slug: slug,
   479	                    name: name,
   480	                    email: email,
   481	                    phone: phone,
   482	                    pixType: pixType,
   483	                    pixKey: pixKey,
   484	                    commission: commission,
   485	                    username: username,
   486	                    password: defaultPassword,
   487	                    passwordChanged: false,
   488	                    createdAt: new Date().toISOString(),
   489	                    sales: [],
   490	                    totalEarned: 0,
   491	                    status: 'active'
   492	                };
   493	
   494	                console.log('üíæ Salvando no Firebase...');
   495	                const docRef = await db.collection('affiliates').add(affiliate);
   496	                console.log('‚úÖ Criado com ID:', docRef.id);
   497	
   498	                alert(
   499	                    '‚úÖ Divulgador cadastrado com sucesso!\n\n' +
   500	                    'üîê CREDENCIAIS DE ACESSO:\n' +
   501	                    'üë§ Usu√°rio: ' + affiliate.username + '\n' +
   502	                    'üîë Senha: ' + affiliate.password + '\n\n' +
   503	                    'üîó Link personalizado: ?ref=' + affiliate.slug + '\n\n' +
   504	                    'üåê Login: https://kainow.com.br/afiliado/login.html\n\n' +
   505	                    'üí∞ Comiss√µes via PIX: ' + pixKey + '\n\n' +
   506	                    '‚ö†Ô∏è IMPORTANTE: Envie estas credenciais para o divulgador!'
   507	                );
   508	
   509	                closeNewAffiliateModal();
   510	                document.getElementById('affiliate-form').reset();
   511	                await renderAffiliates();
   512	                await updateStats();
   513	
   514	            } catch (error) {
   515	                console.error('‚ùå Erro ao criar afiliado:', error);
   516	                alert('‚ùå Erro ao criar afiliado: ' + error.message);
   517	            } finally {
   518	                submitButton.disabled = false;
   519	                submitButton.innerHTML = '<i class="fas fa-save mr-2"></i> Criar Divulgador';
   520	            }
   521	        });
   522	
   523	        // Vari√°vel global para armazenar afiliado atual
   524	        let currentAffiliate = null;
   525	
   526	        // Mostrar login do afiliado
   527	        async function showLogin(affiliateId) {
   528	            const affiliates = await loadAffiliates();
   529	            const affiliate = affiliates.find(a => a.id === affiliateId);
   530	
   531	            if (!affiliate) return;
   532	
   533	            currentAffiliate = affiliate;
   534	
   535	            const passwordStatus = affiliate.passwordChanged 
   536	                ? '<span class="text-green-600"><i class="fas fa-check-circle mr-2"></i>Senha j√° foi alterada</span>' 
   537	                : '<span class="text-yellow-600"><i class="fas fa-exclamation-triangle mr-2"></i>Senha padr√£o (n√£o alterada)</span>';
   538	
   539	            const loginInfoHtml = `
   540	                <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 rounded-xl">
   541	                    <div class="flex items-center space-x-3 mb-3">
   542	                        <div class="bg-white text-blue-600 w-12 h-12 rounded-full flex items-center justify-center text-lg font-bold">
   543	                            ${affiliate.name.charAt(0).toUpperCase()}
   544	                        </div>
   545	                        <div>
   546	                            <h4 class="text-lg font-bold">${affiliate.name}</h4>
   547	                            <p class="opacity-90 text-sm">${affiliate.email}</p>
   548	                        </div>
   549	                    </div>
   550	                    <div class="grid grid-cols-2 gap-3 text-xs">
   551	                        <div>
   552	                            <p class="opacity-75">Telefone:</p>
   553	                            <p class="font-bold">${affiliate.phone}</p>
   554	                        </div>
   555	                        <div>
   556	                            <p class="opacity-75">ID:</p>
   557	                            <p class="font-bold">${affiliate.id}</p>
   558	                        </div>
   559	                        <div>
   560	                            <p class="opacity-75">Comiss√£o:</p>
   561	                            <p class="font-bold">${affiliate.commission}%</p>
   562	                        </div>
   563	                        <div>
   564	                            <p class="opacity-75">PIX:</p>
   565	                            <p class="font-bold">${affiliate.pixKey || 'N√£o cadastrado'}</p>
   566	                        </div>
   567	                    </div>
   568	                </div>
   569	
   570	                <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-4">
   571	                    <h5 class="text-base font-bold text-gray-800 mb-3">
   572	                        <i class="fas fa-key text-blue-600 mr-2"></i>
   573	                        Credenciais de Login
   574	                    </h5>
   575	                    <div class="space-y-2">
   576	                        <div class="bg-white p-3 rounded-lg border border-gray-200">
   577	                            <label class="block text-xs font-bold text-gray-600 mb-1">USU√ÅRIO</label>
   578	                            <div class="flex items-center justify-between">
   579	                                <span class="text-base font-bold text-gray-800">${affiliate.username || 'N√£o gerado'}</span>
   580	                                <button 
   581	                                    onclick="copyToClipboard('${affiliate.username}')"
   582	                                    class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition"
   583	                                >
   584	                                    <i class="fas fa-copy"></i>
   585	                                </button>
   586	                            </div>
   587	                        </div>
   588	                        
   589	                        <div class="bg-white p-3 rounded-lg border border-gray-200">
   590	                            <label class="block text-xs font-bold text-gray-600 mb-1">SENHA</label>
   591	                            <div class="flex items-center justify-between">
   592	                                <span class="text-base font-bold text-gray-800 font-mono">${affiliate.password || 'N√£o gerada'}</span>
   593	                                <button 
   594	                                    onclick="copyToClipboard('${affiliate.password}')"
   595	                                    class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition"
   596	                                >
   597	                                    <i class="fas fa-copy"></i>
   598	                                </button>
   599	                            </div>
   600	                        </div>
   601	
   602	                        <div class="bg-white p-3 rounded-lg border border-gray-200">
   603	                            <label class="block text-xs font-bold text-gray-600 mb-1">LINK</label>
   604	                            <div class="flex items-center justify-between gap-2">
   605	                                <span class="text-xs text-blue-600 truncate">https://kainow.com.br/afiliado/login.html</span>
   606	                                <button 
   607	                                    onclick="copyToClipboard('https://kainow.com.br/afiliado/login.html')"
   608	                                    class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition flex-shrink-0"
   609	                                >
   610	                                    <i class="fas fa-copy"></i>
   611	                                </button>
   612	                            </div>
   613	                        </div>
   614	                    </div>
   615	
   616	                    <div class="mt-3 p-2 bg-white rounded-lg border-l-4 border-${affiliate.passwordChanged ? 'green' : 'yellow'}-500">
   617	                        <p class="text-xs font-bold">${passwordStatus}</p>
   618	                    </div>
   619	                </div>
   620	
   621	                <div class="bg-green-50 border-2 border-green-200 rounded-xl p-4">
   622	                    <h5 class="text-base font-bold text-gray-800 mb-3">
   623	                        <i class="fas fa-comment-dots text-green-600 mr-2"></i>
   624	                        Mensagem Pronta para Enviar
   625	                    </h5>
   626	                    <div class="bg-white p-3 rounded-lg border-2 border-gray-200">
   627	                        <pre id="whatsapp-message" class="text-xs text-gray-700 whitespace-pre-wrap font-sans">üéâ Ol√° ${affiliate.name}!
   628	
   629	Voc√™ foi cadastrado como divulgador da KaiNow Sa√∫de!
   630	
   631	üîê CREDENCIAIS DE ACESSO:
   632	üë§ Usu√°rio: ${affiliate.username}
   633	üîë Senha: ${affiliate.password}
   634	
   635	üåê Acesse seu painel:
   636	https://kainow.com.br/afiliado/login.html
   637	
   638	üí∞ Sua comiss√£o: ${affiliate.commission}%
   639	üí≥ Recebimento PIX: ${affiliate.pixKey || 'A cadastrar'}
   640	
   641	‚ö†Ô∏è IMPORTANTE: Troque sua senha no primeiro acesso!
   642	
   643	Qualquer d√∫vida, estou √† disposi√ß√£o! üòä</pre>
   644	                    </div>
   645	                </div>
   646	            `;
   647	
   648	            document.getElementById('login-info').innerHTML = loginInfoHtml;
   649	            document.getElementById('login-modal').classList.remove('hidden');
   650	        }
   651	
   652	        // Fechar modal de login
   653	        function closeLoginModal() {
   654	            document.getElementById('login-modal').classList.add('hidden');
   655	            currentAffiliate = null;
   656	        }
   657	
   658	        // Copiar para √°rea de transfer√™ncia
   659	        function copyToClipboard(text) {
   660	            if (navigator.clipboard) {
   661	                navigator.clipboard.writeText(text).then(() => {
   662	                    alert('‚úÖ Copiado para √°rea de transfer√™ncia!');
   663	                }).catch(err => {
   664	                    alert('‚ùå Erro ao copiar: ' + err);
   665	                });
   666	            } else {
   667	                const textarea = document.createElement('textarea');
   668	                textarea.value = text;
   669	                document.body.appendChild(textarea);
   670	                textarea.select();
   671	                document.execCommand('copy');
   672	                document.body.removeChild(textarea);
   673	                alert('‚úÖ Copiado!');
   674	            }
   675	        }
   676	
   677	        // Copiar todas as credenciais
   678	        function copyLoginCredentials() {
   679	            if (!currentAffiliate) return;
   680	
   681	            const text = 
   682	                `üîê CREDENCIAIS DE ACESSO\n\n` +
   683	                `üë§ Usu√°rio: ${currentAffiliate.username}\n` +
   684	                `üîë Senha: ${currentAffiliate.password}\n` +
   685	                `üåê Link: https://kainow.com.br/afiliado/login.html`;
   686	
   687	            copyToClipboard(text);
   688	        }
   689	
   690	        // Enviar via WhatsApp
   691	        function sendWhatsApp() {
   692	            if (!currentAffiliate) return;
   693	
   694	            const message = 
   695	                `üéâ Ol√° ${currentAffiliate.name}!\n\n` +
   696	                `Voc√™ foi cadastrado como divulgador da KaiNow Sa√∫de!\n\n` +
   697	                `üîê CREDENCIAIS DE ACESSO:\n` +
   698	                `üë§ Usu√°rio: ${currentAffiliate.username}\n` +
   699	                `üîë Senha: ${currentAffiliate.password}\n\n` +
   700	                `üåê Acesse seu painel:\n` +
   701	                `https://kainow.com.br/afiliado/login.html\n\n` +
   702	                `üí∞ Sua comiss√£o: ${currentAffiliate.commission}%\n` +
   703	                `üí≥ Recebimento PIX: ${currentAffiliate.pixKey || 'A cadastrar'}\n\n` +
   704	                `‚ö†Ô∏è IMPORTANTE: Troque sua senha no primeiro acesso!\n\n` +
   705	                `Qualquer d√∫vida, estou √† disposi√ß√£o! üòä`;
   706	
   707	            const phone = currentAffiliate.phone.replace(/\D/g, '');
   708	            const whatsappUrl = `https://wa.me/55${phone}?text=${encodeURIComponent(message)}`;
   709	            
   710	            window.open(whatsappUrl, '_blank');
   711	        }
   712	
   713	        // Mostrar links do afiliado
   714	        async function showLinks(affiliateId) {
   715	            const affiliates = await loadAffiliates();
   716	            const affiliate = affiliates.find(a => a.id === affiliateId);
   717	
   718	            if (!affiliate) return;
   719	
   720	            const infoHtml = `
   721	                <div class="flex justify-between items-start">
   722	                    <div>
   723	                        <h4 class="text-lg font-bold">${affiliate.name}</h4>
   724	                        <p class="opacity-90 mb-2 text-sm">${affiliate.email}</p>
   725	                        ${affiliate.pixKey ? `
   726	                        <div class="bg-white bg-opacity-20 rounded-lg px-3 py-1.5 inline-block">
   727	                            <p class="text-xs font-semibold">
   728	                                <i class="fab fa-pix mr-1"></i>
   729	                                PIX: ${affiliate.pixKey}
   730	                            </p>
   731	                            <p class="text-xs opacity-80">Tipo: ${affiliate.pixType.toUpperCase()}</p>
   732	                        </div>
   733	                        ` : ''}
   734	                    </div>
   735	                    <div class="text-right">
   736	                        <p class="text-2xl font-black">${affiliate.commission}%</p>
   737	                        <p class="text-xs opacity-90">comiss√£o</p>
   738	                    </div>
   739	                </div>
   740	            `;
   741	
   742	            const linksHtml = products.map(product => {
   743	                const refParam = affiliate.slug || affiliate.username;
   744	                const affiliateLink = `https://kainow.com.br/programa-${product.id}.html?ref=${refParam}`;
   745	                
   746	                return `
   747	                    <div class="border-2 border-${product.color}-200 bg-${product.color}-50 rounded-xl p-4">
   748	                        <div class="flex items-center mb-3">
   749	                            <div class="bg-gradient-to-r from-${product.color}-500 to-${product.color}-600 rounded-full w-10 h-10 flex items-center justify-center text-white mr-3 text-sm">
   750	                                <i class="fas ${product.icon}"></i>
   751	                            </div>
   752	                            <div>
   753	                                <h5 class="text-base font-bold text-gray-800">${product.name}</h5>
   754	                                <p class="text-sm text-gray-600">R$ ${product.price}/m√™s</p>
   755	                            </div>
   756	                        </div>
   757	                        
   758	                        <div class="bg-white p-3 rounded-lg mb-2">
   759	                            <p class="text-xs text-gray-600 mb-1 font-bold">Link:</p>
   760	                            <div class="flex items-center gap-2">
   761	                                <input type="text" value="${affiliateLink}" readonly class="flex-1 px-2 py-1.5 bg-gray-50 border border-gray-300 rounded text-xs" id="link-${product.id}-${affiliateId}">
   762	                                <button onclick="copyLink('link-${product.id}-${affiliateId}')" class="bg-primary text-white px-3 py-1.5 rounded hover:bg-opacity-90 transition text-xs">
   763	                                    <i class="fas fa-copy"></i>
   764	                                </button>
   765	                            </div>
   766	                        </div>
   767	
   768	                        <div class="grid grid-cols-2 gap-2">
   769	                            <div class="bg-green-100 p-2 rounded-lg">
   770	                                <p class="text-xs text-gray-700 mb-0.5">
   771	                                    <i class="fab fa-pix mr-1"></i>
   772	                                    Divulgador
   773	                                </p>
   774	                                <p class="text-base font-bold text-green-700">R$ ${(parseFloat(product.price.replace(',', '.')) * affiliate.commission / 100).toFixed(2).replace('.', ',')}</p>
   775	                                ${affiliate.pixKey ? `<p class="text-xs text-gray-600 mt-0.5 truncate">‚Ü™ ${affiliate.pixKey}</p>` : ''}
   776	                            </div>
   777	                            <div class="bg-purple-100 p-2 rounded-lg">
   778	                                <p class="text-xs text-gray-700 mb-0.5">Plataforma</p>
   779	                                <p class="text-base font-bold text-purple-700">R$ ${(parseFloat(product.price.replace(',', '.')) * (100 - affiliate.commission) / 100).toFixed(2).replace('.', ',')}</p>
   780	                            </div>
   781	                        </div>
   782	                    </div>
   783	                `;
   784	            }).join('');
   785	
   786	            document.getElementById('affiliate-info').innerHTML = infoHtml;
   787	            document.getElementById('products-links').innerHTML = linksHtml;
   788	            document.getElementById('affiliate-links-modal').classList.remove('hidden');
   789	        }
   790	
   791	        // Fechar modal de links
   792	        function closeLinksModal() {
   793	            document.getElementById('affiliate-links-modal').classList.add('hidden');
   794	        }
   795	
   796	        // Copiar link
   797	        function copyLink(inputId) {
   798	            const input = document.getElementById(inputId);
   799	            input.select();
   800	            document.execCommand('copy');
   801	            
   802	            alert('‚úÖ Link copiado para √°rea de transfer√™ncia!');
   803	        }
   804	
   805	        // Editar comiss√£o
   806	        async function editCommission(affiliateId) {
   807	            const affiliates = await loadAffiliates();
   808	            const affiliate = affiliates.find(a => a.id === affiliateId);
   809	
   810	            if (!affiliate) return;
   811	
   812	            const currentPix = affiliate.pixKey || 'N√£o cadastrado';
   813	            const editData = prompt(
   814	                `üìù EDITAR AFILIADO: ${affiliate.name}\n\n` +
   815	                `üí∞ Comiss√£o atual: ${affiliate.commission}%\n` +
   816	                `üí≥ PIX atual: ${currentPix}\n\n` +
   817	                `Digite a nova comiss√£o (0-100):`,
   818	                affiliate.commission
   819	            );
   820	
   821	            if (editData === null) return;
   822	
   823	            const commission = parseInt(editData);
   824	
   825	            if (isNaN(commission) || commission < 0 || commission > 100) {
   826	                alert('‚ùå Comiss√£o inv√°lida! Digite um valor entre 0 e 100.');
   827	                return;
   828	            }
   829	
   830	            const updatePix = confirm('üí≥ Deseja atualizar a chave PIX tamb√©m?');
   831	            
   832	            if (updatePix) {
   833	                const newPixKey = prompt(
   834	                    `üí≥ PIX atual: ${currentPix}\n\nDigite a nova chave PIX:`,
   835	                    affiliate.pixKey || ''
   836	                );
   837	                
   838	                if (newPixKey && newPixKey.trim() !== '') {
   839	                    affiliate.pixKey = newPixKey.trim();
   840	                    
   841	                    const pixType = prompt(
   842	                        'üì± Selecione o tipo de chave PIX:\n\n' +
   843	                        '1 - CPF\n' +
   844	                        '2 - CNPJ\n' +
   845	                        '3 - Email\n' +
   846	                        '4 - Telefone\n' +
   847	                        '5 - Chave Aleat√≥ria\n\n' +
   848	                        'Digite o n√∫mero:',
   849	                        '1'
   850	                    );
   851	                    
   852	                    const pixTypes = {
   853	                        '1': 'cpf',
   854	                        '2': 'cnpj',
   855	                        '3': 'email',
   856	                        '4': 'telefone',
   857	                        '5': 'aleatoria'
   858	                    };
   859	                    
   860	                    affiliate.pixType = pixTypes[pixType] || 'cpf';
   861	                }
   862	            }
   863	
   864	            try {
   865	                const updateData = { commission: commission };
   866	                
   867	                if (updatePix && affiliate.pixKey) {
   868	                    updateData.pixKey = affiliate.pixKey;
   869	                    updateData.pixType = affiliate.pixType || 'cpf';
   870	                }
   871	                
   872	                console.log('üìù Atualizando afiliado:', affiliateId, updateData);
   873	                await db.collection('affiliates').doc(affiliateId).update(updateData);
   874	                
   875	                alert('‚úÖ Afiliado atualizado com sucesso!');
   876	                await updateStats();
   877	                await renderAffiliates();
   878	            } catch (error) {
   879	                console.error('‚ùå Erro ao atualizar:', error);
   880	                alert('‚ùå Erro ao atualizar afiliado: ' + error.message);
   881	            }
   882	        }
   883	
   884	        // Excluir afiliado
   885	        async function deleteAffiliate(affiliateId) {
   886	            if (!confirm('Tem certeza que deseja excluir este divulgador?')) return;
   887	
   888	            try {
   889	                console.log('üóëÔ∏è Deletando afiliado:', affiliateId);
   890	                await db.collection('affiliates').doc(affiliateId).delete();
   891	                alert('‚úÖ Divulgador exclu√≠do com sucesso!');
   892	                await updateStats();
   893	                await renderAffiliates();
   894	            } catch (error) {
   895	                console.error('‚ùå Erro ao deletar:', error);
   896	                alert('‚ùå Erro ao excluir divulgador: ' + error.message);
   897	            }
   898	        }
   899	
   900	        // Logout
   901	        function logout() {
   902	            if (confirm('Deseja sair do painel administrativo?')) {
   903	                localStorage.removeItem('kainow_admin_session');
   904	                sessionStorage.removeItem('kainow_admin_session');
   905	                window.location.href = 'login-admin.html';
   906	            }
   907	        }
   908	
   909	        // Preview do slug em tempo real
   910	        document.getElementById('affiliate-slug').addEventListener('input', function(e) {
   911	            let slug = e.target.value.toLowerCase().trim();
   912	            slug = slug.replace(/[^a-z0-9-]/g, '');
   913	            e.target.value = slug;
   914	            
   915	            const preview = document.getElementById('slug-preview');
   916	            if (slug) {
   917	                preview.textContent = slug;
   918	                preview.classList.remove('text-gray-400');
   919	                preview.classList.add('text-blue-600', 'font-bold');
   920	            } else {
   921	                preview.textContent = 'seu-nome';
   922	                preview.classList.add('text-gray-400');
   923	                preview.classList.remove('text-blue-600', 'font-bold');
   924	            }
   925	        });
   926	
   927	        // Inicializar
   928	        updateStats();
   929	        renderAffiliates();
   930	        
   931	        console.log('üöÄ Gerenciador de Afiliados v3.1 carregado!');
   932	        console.log('üìÖ Timestamp:', new Date().toISOString());
   933	        console.log('üîó Dom√≠nio dos links: kainow.com.br');
   934	        
   935	        const versionBanner = document.createElement('div');
   936	        versionBanner.className = 'fixed top-20 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-2xl z-50';
   937	        versionBanner.innerHTML = `
   938	            <div class="flex items-center space-x-3">
   939	                <i class="fas fa-check-circle text-2xl"></i>
   940	                <div>
   941	                    <p class="font-bold">Vers√£o 3.1 Carregada!</p>
   942	                    <p class="text-xs">Salva no Firebase ‚úÖ</p>
   943	                </div>
   944	            </div>
   945	        `;
   946	        document.body.appendChild(versionBanner);
   947	        setTimeout(() => versionBanner.remove(), 5000);
   948	
   949	        window.addEventListener('DOMContentLoaded', async function() {
   950	            console.log('üöÄ P√°gina carregada, buscando afiliados do Firestore...');
   951	            await updateStats();
   952	            await renderAffiliates();
   953	        });
   954	    </script>
   955	    
   956	    <script src="../js/admin-auth.js"></script>
   957	    <script>
   958	        checkAdminAuth();
   959	    </script>
   960	</body>
   961	</html>
   962	
