   1	<!DOCTYPE html>
     2	<html lang="pt-BR">
     3	<head>
     4	    <meta charset="UTF-8">
     5	    <meta name="viewport" content="width=device-width, initial-scale=1.0">
     6	    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
     7	    <meta http-equiv="Pragma" content="no-cache">
     8	    <meta http-equiv="Expires" content="0">
     9	    <title>Gerenciador de Afiliados - KaiNow Admin v3.0</title>
    10	    <script src="https://cdn.tailwindcss.com"></script>
    11	    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    12	    
    13	    <!-- Firebase SDKs -->
    14	    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    15	    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    16	</head>
    17	<body class="bg-gray-50">
    18	    <!-- Header -->
    19	    <header class="bg-white shadow-lg border-b-4 border-blue-500">
    20	        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
    21	            <div class="flex items-center space-x-4">
    22	                <button onclick="window.location.href='dashboard-admin.html'" class="text-gray-600 hover:text-gray-800">
    23	                    <i class="fas fa-arrow-left text-xl"></i>
    24	                </button>
    25	                <div>
    26	                    <h1 class="text-2xl font-bold text-gray-800">Gerenciar Afiliados</h1>
    27	                    <p class="text-sm text-gray-600">Criar afiliados e gerar links</p>
    28	                </div>
    29	            </div>
    30	            
    31	            <button 
    32	                onclick="logout()"
    33	                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition"
    34	            >
    35	                <i class="fas fa-sign-out-alt mr-2"></i>
    36	                Sair
    37	            </button>
    38	        </div>
    39	    </header>
    40	
    41	    <div class="container mx-auto px-4 py-8">
    42	        <!-- T√≠tulo -->
    43	        <div class="mb-8">
    44	            <div class="flex justify-between items-center">
    45	                <div>
    46	                    <h2 class="text-3xl font-bold text-gray-800 mb-2">
    47	                        <i class="fas fa-users-cog text-blue-600 mr-3"></i>
    48	                        Gerenciador de Afiliados
    49	                        <span class="text-sm bg-green-500 text-white px-2 py-1 rounded ml-2">v3.1</span>
    50	                    </h2>
    51	                    <p class="text-gray-600">Crie divulgadores, gere links e gerencie comiss√µes</p>
    52	                </div>
    53	                <button 
    54	                    onclick="location.reload(true)"
    55	                    class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition"
    56	                >
    57	                    <i class="fas fa-sync-alt mr-2"></i>
    58	                    For√ßar Atualiza√ß√£o
    59	                </button>
    60	            </div>
    61	        </div>
    62	
    63	        <!-- Cards Estat√≠sticas -->
    64	        <div class="grid md:grid-cols-4 gap-6 mb-8">
    65	            <div class="bg-white rounded-xl shadow-lg p-6">
    66	                <div class="flex items-center justify-between">
    67	                    <div>
    68	                        <p class="text-gray-600 text-sm">Total Afiliados</p>
    69	                        <h3 class="text-3xl font-bold text-blue-600" id="total-affiliates">0</h3>
    70	                    </div>
    71	                    <i class="fas fa-users text-4xl text-blue-600 opacity-20"></i>
    72	                </div>
    73	            </div>
    74	            
    75	            <div class="bg-white rounded-xl shadow-lg p-6">
    76	                <div class="flex items-center justify-between">
    77	                    <div>
    78	                        <p class="text-gray-600 text-sm">Links Gerados</p>
    79	                        <h3 class="text-3xl font-bold text-green-600" id="total-links">0</h3>
    80	                    </div>
    81	                    <i class="fas fa-link text-4xl text-green-600 opacity-20"></i>
    82	                </div>
    83	            </div>
    84	            
    85	            <div class="bg-white rounded-xl shadow-lg p-6">
    86	                <div class="flex items-center justify-between">
    87	                    <div>
    88	                        <p class="text-gray-600 text-sm">Comiss√£o Padr√£o</p>
    89	                        <h3 class="text-3xl font-bold text-amber-600">20%</h3>
    90	                    </div>
    91	                    <i class="fas fa-percentage text-4xl text-amber-600 opacity-20"></i>
    92	                </div>
    93	            </div>
    94	            
    95	            <div class="bg-white rounded-xl shadow-lg p-6">
    96	                <div class="flex items-center justify-between">
    97	                    <div>
    98	                        <p class="text-gray-600 text-sm">Plataforma</p>
    99	                        <h3 class="text-3xl font-bold text-purple-600">80%</h3>
   100	                    </div>
   101	                    <i class="fas fa-building text-4xl text-purple-600 opacity-20"></i>
   102	                </div>
   103	            </div>
   104	        </div>
   105	
   106	        <!-- Bot√£o Novo Afiliado -->
   107	        <div class="mb-6">
   108	            <button onclick="openNewAffiliateModal()" class="bg-gradient-to-r from-blue-600 to-blue-800 text-white px-6 py-3 rounded-lg font-bold hover:shadow-xl transition">
   109	                <i class="fas fa-user-plus mr-2"></i>
   110	                Novo Divulgador
   111	            </button>
   112	        </div>
   113	
   114	        <!-- Lista de Afiliados -->
   115	        <div class="bg-white rounded-xl shadow-lg p-6">
   116	            <h3 class="text-xl font-bold text-gray-800 mb-6">
   117	                <i class="fas fa-list mr-2"></i>
   118	                Divulgadores Cadastrados
   119	            </h3>
   120	            <div id="affiliates-list" class="space-y-4">
   121	                <!-- Afiliados ser√£o listados aqui -->
   122	            </div>
   123	        </div>
   124	    </div>
   125	
   126	    <!-- Modal: Novo Afiliado -->
   127	    <div id="new-affiliate-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
   128	        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[85vh] overflow-y-auto p-6">
   129	            <div class="flex justify-between items-center mb-4">
   130	                <h3 class="text-xl font-bold text-gray-800">
   131	                    <i class="fas fa-user-plus text-blue-600 mr-2"></i>
   132	                    Novo Divulgador
   133	                </h3>
   134	                <button onclick="closeNewAffiliateModal()" class="text-gray-500 hover:text-gray-700">
   135	                    <i class="fas fa-times text-xl"></i>
   136	                </button>
   137	            </div>
   138	
   139	            <form id="affiliate-form" class="space-y-3">
   140	                <div>
   141	                    <label class="block text-xs font-bold text-gray-700 mb-1">Nome do Divulgador</label>
   142	                    <input type="text" id="affiliate-name" required class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none text-sm">
   143	                </div>
   144	
   145	                <div>
   146	                    <label class="block text-xs font-bold text-gray-700 mb-1">Email</label>
   147	                    <input type="email" id="affiliate-email" required class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none text-sm">
   148	                </div>
   149	
   150	                <div>
   151	                    <label class="block text-xs font-bold text-gray-700 mb-1">Telefone/WhatsApp</label>
   152	                    <input type="tel" id="affiliate-phone" required class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none text-sm" placeholder="(00) 00000-0000">
   153	                </div>
   154	
   155	                <div class="bg-green-50 border border-green-300 rounded-lg p-3">
   156	                    <label class="block text-xs font-bold text-gray-700 mb-1">
   157	                        <i class="fab fa-pix text-green-600 mr-1"></i>
   158	                        Chave PIX
   159	                    </label>
   160	                    <select id="affiliate-pix-type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none mb-2 text-sm">
   161	                        <option value="cpf">CPF</option>
   162	                        <option value="cnpj">CNPJ</option>
   163	                        <option value="email">Email</option>
   164	                        <option value="telefone">Telefone</option>
   165	                        <option value="aleatoria">Chave Aleat√≥ria</option>
   166	                    </select>
   167	                    <input type="text" id="affiliate-pix" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none text-sm" placeholder="Digite a chave PIX">
   168	                    <p class="text-xs text-gray-600 mt-1">
   169	                        <i class="fas fa-info-circle mr-1"></i>
   170	                        Comiss√µes via esta chave
   171	                    </p>
   172	                </div>
   173	
   174	                <div class="bg-blue-50 border border-blue-300 rounded-lg p-3">
   175	                    <label class="block text-xs font-bold text-gray-700 mb-1">
   176	                        <i class="fas fa-link text-blue-600 mr-1"></i>
   177	                        Nome/Apelido no Link (Opcional)
   178	                    </label>
   179	                    <input 
   180	                        type="text" 
   181	                        id="affiliate-slug" 
   182	                        placeholder="Ex: joaosilva"
   183	                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none text-sm"
   184	                        pattern="[a-z0-9-]+"
   185	                        maxlength="30"
   186	                    >
   187	                    <p class="text-xs text-gray-600 mt-1">
   188	                        <i class="fas fa-info-circle mr-1"></i>
   189	                        Apenas letras min√∫sculas, n√∫meros e h√≠fen. Deixe vazio para gerar automaticamente.
   190	                    </p>
   191	                    <p class="text-xs text-blue-600 mt-1">
   192	                        Ex: ...?ref=<span id="slug-preview">joaosilva</span>
   193	                    </p>
   194	                </div>
   195	
   196	                <div>
   197	                    <label class="block text-xs font-bold text-gray-700 mb-1">Comiss√£o (%)</label>
   198	                    <input type="number" id="affiliate-commission" value="20" min="0" max="100" required class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none text-sm">
   199	                    <p class="text-xs text-gray-500 mt-1">Padr√£o: 20% para divulgador, 80% para plataforma</p>
   200	                </div>
   201	
   202	                <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-blue-800 text-white px-4 py-3 rounded-lg font-bold hover:shadow-xl transition text-sm">
   203	                    <i class="fas fa-save mr-2"></i>
   204	                    Criar Divulgador
   205	                </button>
   206	            </form>
   207	        </div>
   208	    </div>
   209	
   210	    <!-- Modal: Links do Afiliado -->
   211	    <div id="affiliate-links-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
   212	        <div class="bg-white rounded-2xl max-w-3xl w-full max-h-[85vh] overflow-y-auto p-6">
   213	            <div class="flex justify-between items-center mb-4">
   214	                <h3 class="text-xl font-bold text-gray-800">
   215	                    <i class="fas fa-link text-blue-600 mr-2"></i>
   216	                    Links de Divulga√ß√£o
   217	                </h3>
   218	                <button onclick="closeLinksModal()" class="text-gray-500 hover:text-gray-700">
   219	                    <i class="fas fa-times text-xl"></i>
   220	                </button>
   221	            </div>
   222	
   223	            <div id="affiliate-info" class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-4 rounded-xl mb-4">
   224	                <!-- Informa√ß√µes do afiliado -->
   225	            </div>
   226	
   227	            <div id="products-links" class="space-y-3">
   228	                <!-- Links dos produtos -->
   229	            </div>
   230	        </div>
   231	    </div>
   232	
   233	    <!-- Modal Ver Login -->
   234	    <div id="login-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
   235	        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[85vh] overflow-y-auto p-6">
   236	            <div class="flex justify-between items-center mb-4">
   237	                <h3 class="text-xl font-bold text-gray-800">
   238	                    <i class="fas fa-key text-blue-600 mr-2"></i>
   239	                    Credenciais de Acesso
   240	                </h3>
   241	                <button onclick="closeLoginModal()" class="text-gray-500 hover:text-gray-700">
   242	                    <i class="fas fa-times text-xl"></i>
   243	                </button>
   244	            </div>
   245	
   246	            <div id="login-info" class="space-y-4">
   247	                <!-- Informa√ß√µes ser√£o inseridas aqui -->
   248	            </div>
   249	
   250	            <div class="mt-4 flex space-x-2">
   251	                <button 
   252	                    onclick="copyLoginCredentials()"
   253	                    class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded-lg transition text-sm"
   254	                >
   255	                    <i class="fas fa-copy mr-1"></i>
   256	                    Copiar
   257	                </button>
   258	                <button 
   259	                    onclick="sendWhatsApp()"
   260	                    class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg transition text-sm"
   261	                >
   262	                    <i class="fab fa-whatsapp mr-1"></i>
   263	                    WhatsApp
   264	                </button>
   265	                <button 
   266	                    onclick="closeLoginModal()"
   267	                    class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition text-sm"
   268	                >
   269	                    Fechar
   270	                </button>
   271	            </div>
   272	        </div>
   273	    </div>
   274	
   275	    <script type="text/javascript">
   276	        // Dados dos produtos
   277	        const products = [
   278	            { id: 'mulher', name: 'KaiNow Mulher', price: '49,90', color: 'pink', icon: 'fa-venus' },
   279	            { id: 'senior', name: 'KaiNow S√™nior', price: '59,90', color: 'amber', icon: 'fa-user-shield' },
   280	            { id: 'farma', name: 'KaiNow Farma', price: '19,90', color: 'green', icon: 'fa-pills' },
   281	            { id: 'acolher', name: 'KaiNow Acolher', price: '24,90', color: 'blue', icon: 'fa-hands-holding-child' },
   282	            { id: 'orienta', name: 'KaiNow Orienta', price: '19,90', color: 'purple', icon: 'fa-lightbulb' },
   283	            { id: 'vivaleve', name: 'KaiNow Viva Leve', price: '24,90', color: 'teal', icon: 'fa-spa' }
   284	        ];
   285	
   286	        // Configura√ß√£o Firebase
   287	        const firebaseConfig = {
   288	            apiKey: "AIzaSyA2-tCGH1uaABTzMqhK_BhTy-zIZba0wMs",
   289	            authDomain: "kainowsaude.firebaseapp.com",
   290	            projectId: "kainowsaude",
   291	            storageBucket: "kainowsaude.firebasestorage.app",
   292	            messagingSenderId: "230049250523",
   293	            appId: "1:230049250523:web:ce16ada5c4e5488e64e0fe"
   294	        };
   295	
   296	        firebase.initializeApp(firebaseConfig);
   297	        const db = firebase.firestore();
   298	        console.log('üî• Firebase inicializado');
   299	
   300	        // Carregar afiliados do Firestore
   301	        async function loadAffiliates() {
   302	            try {
   303	                console.log('üì° Carregando afiliados do Firestore...');
   304	                const snapshot = await db.collection('affiliates').get();
   305	                
   306	                const affiliates = snapshot.docs.map(doc => ({
   307	                    id: doc.id,
   308	                    ...doc.data()
   309	                }));
   310	                
   311	                console.log('‚úÖ ' + affiliates.length + ' afiliados carregados');
   312	                return affiliates;
   313	            } catch (error) {
   314	                console.error('‚ùå Erro ao carregar afiliados:', error);
   315	                return [];
   316	            }
   317	        }
   318	
   319	        // Atualizar estat√≠sticas
   320	        async function updateStats() {
   321	            const affiliates = await loadAffiliates();
   322	            document.getElementById('total-affiliates').textContent = affiliates.length;
   323	            document.getElementById('total-links').textContent = affiliates.length * products.length;
   324	        }
   325	
   326	        // Renderizar lista de afiliados
   327	        async function renderAffiliates() {
   328	            const affiliates = await loadAffiliates();
   329	            const container = document.getElementById('affiliates-list');
   330	
   331	            if (affiliates.length === 0) {
   332	                container.innerHTML = '<div class="text-center py-12 text-gray-500"><i class="fas fa-users text-6xl mb-4 opacity-20"></i><p class="text-lg">Nenhum divulgador cadastrado ainda</p><button onclick="openNewAffiliateModal()" class="mt-4 text-blue-600 hover:underline"><i class="fas fa-plus mr-2"></i>Cadastrar primeiro divulgador</button></div>';
   333	                return;
   334	            }
   335	
   336	            container.innerHTML = affiliates.map(affiliate => {
   337	                return '<div class="border-2 border-gray-200 rounded-xl p-6 hover:border-blue-600 transition"><div class="flex justify-between items-start"><div class="flex items-start space-x-4"><div class="bg-gradient-to-br from-blue-600 to-blue-800 rounded-full w-16 h-16 flex items-center justify-center text-white text-2xl font-bold">' + affiliate.name.charAt(0).toUpperCase() + '</div><div><h4 class="text-xl font-bold text-gray-800">' + affiliate.name + '</h4><p class="text-gray-600"><i class="fas fa-envelope mr-2"></i>' + affiliate.email + '</p><p class="text-gray-600"><i class="fas fa-phone mr-2"></i>' + affiliate.phone + '</p>' + (affiliate.pixKey ? '<p class="text-green-600 font-semibold mt-1"><i class="fab fa-pix mr-2"></i>PIX: ' + affiliate.pixKey + ' <span class="text-xs text-gray-500">(' + affiliate.pixType + ')</span></p>' : '') + '<div class="mt-2"><span class="inline-block bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-bold"><i class="fas fa-percentage mr-1"></i>' + affiliate.commission + '% comiss√£o</span>' + (affiliate.slug ? '<span class="inline-block bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm font-bold ml-2"><i class="fas fa-link mr-1"></i>ref=' + affiliate.slug + '</span>' : '<span class="inline-block bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm font-bold ml-2">ID: ' + affiliate.id + '</span>') + '</div></div></div><div class="flex flex-col gap-2"><button onclick="showLogin(\'' + affiliate.id + '\')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-opacity-90 transition"><i class="fas fa-key mr-2"></i>Ver Login</button><button onclick="showLinks(\'' + affiliate.id + '\')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-opacity-90 transition"><i class="fas fa-link mr-2"></i>Ver Links</button><button onclick="editCommission(\'' + affiliate.id + '\')" class="bg-amber-500 text-white px-4 py-2 rounded-lg hover:bg-opacity-90 transition"><i class="fas fa-edit mr-2"></i>Editar</button><butt... (line truncated)
   338	            }).join('');
   339	        }
   340	
   341	        // Abrir modal de novo afiliado
   342	        function openNewAffiliateModal() {
   343	            document.getElementById('new-affiliate-modal').classList.remove('hidden');
   344	        }
   345	
   346	        // Fechar modal de novo afiliado
   347	        function closeNewAffiliateModal() {
   348	            document.getElementById('new-affiliate-modal').classList.add('hidden');
   349	            document.getElementById('affiliate-form').reset();
   350	        }
   351	
   352	        // Criar novo afiliado
   353	        document.getElementById('affiliate-form').addEventListener('submit', async function(e) {
   354	            e.preventDefault();
   355	            console.log('üöÄ Formul√°rio submetido!');
   356	
   357	            const name = document.getElementById('affiliate-name').value;
   358	            const email = document.getElementById('affiliate-email').value;
   359	            const phone = document.getElementById('affiliate-phone').value;
   360	            const pixType = document.getElementById('affiliate-pix-type').value;
   361	            const pixKey = document.getElementById('affiliate-pix').value;
   362	            const commission = parseInt(document.getElementById('affiliate-commission').value);
   363	            let slug = document.getElementById('affiliate-slug').value.toLowerCase().trim();
   364	
   365	            console.log('üìù Dados do formul√°rio:', { name: name, email: email, phone: phone, pixKey: pixKey, commission: commission });
   366	
   367	            const submitButton = e.target.querySelector('button[type="submit"]');
   368	            submitButton.disabled = true;
   369	            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Criando...';
   370	
   371	            try {
   372	                console.log('üîÑ Carregando afiliados...');
   373	                const affiliates = await loadAffiliates();
   374	                console.log('‚úÖ Afiliados carregados:', affiliates.length);
   375	
   376	                if (slug) {
   377	                    slug = slug.replace(/[^a-z0-9-]/g, '');
   378	                    if (affiliates.some(a => a.slug === slug)) {
   379	                        alert('‚ùå Este nome/apelido j√° est√° em uso! Escolha outro.');
   380	                        submitButton.disabled = false;
   381	                        submitButton.innerHTML = '<i class="fas fa-save mr-2"></i> Criar Divulgador';
   382	                        return;
   383	                    }
   384	                } else {
   385	                    slug = name.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-').substring(0, 30);
   386	                    
   387	                    let slugCounter = 1;
   388	                    let finalSlug = slug;
   389	                    while (affiliates.some(a => a.slug === finalSlug)) {
   390	                        finalSlug = slug + slugCounter;
   391	                        slugCounter++;
   392	                    }
   393	                    slug = finalSlug;
   394	                }
   395	
   396	                const username = email.split('@')[0].toLowerCase().replace(/[^a-z0-9]/g, '');
   397	                const defaultPassword = 'kainow' + Math.random().toString(36).slice(-6);
   398	                
   399	                const affiliate = {
   400	                    slug: slug,
   401	                    name: name,
   402	                    email: email,
   403	                    phone: phone,
   404	                    pixType: pixType,
   405	                    pixKey: pixKey,
   406	                    commission: commission,
   407	                    username: username,
   408	                    password: defaultPassword,
   409	                    passwordChanged: false,
   410	                    createdAt: new Date().toISOString(),
   411	                    sales: [],
   412	                    totalEarned: 0,
   413	                    status: 'active'
   414	                };
   415	
   416	                console.log('üíæ Salvando no Firebase...');
   417	                const docRef = await db.collection('affiliates').add(affiliate);
   418	                console.log('‚úÖ Criado com ID:', docRef.id);
   419	
   420	                alert('‚úÖ Divulgador cadastrado com sucesso!\n\nüîê CREDENCIAIS DE ACESSO:\nüë§ Usu√°rio: ' + affiliate.username + '\nüîë Senha: ' + affiliate.password + '\n\nüîó Link personalizado: ?ref=' + affiliate.slug + '\n\nüåê Login: https://kainow.com.br/afiliado/login.html\n\nüí∞ Comiss√µes via PIX: ' + pixKey + '\n\n‚ö†Ô∏è IMPORTANTE: Envie estas credenciais para o divulgador!');
   421	
   422	                closeNewAffiliateModal();
   423	                document.getElementById('affiliate-form').reset();
   424	                await renderAffiliates();
   425	                await updateStats();
   426	
   427	            } catch (error) {
   428	                console.error('‚ùå Erro ao criar afiliado:', error);
   429	                alert('‚ùå Erro ao criar afiliado: ' + error.message);
   430	            } finally {
   431	                submitButton.disabled = false;
   432	                submitButton.innerHTML = '<i class="fas fa-save mr-2"></i> Criar Divulgador';
   433	            }
   434	        });
   435	
   436	        // Vari√°vel global para armazenar afiliado atual
   437	        let currentAffiliate = null;
   438	
   439	        // Mostrar login do afiliado
   440	        async function showLogin(affiliateId) {
   441	            const affiliates = await loadAffiliates();
   442	            const affiliate = affiliates.find(a => a.id === affiliateId);
   443	            if (!affiliate) return;
   444	            currentAffiliate = affiliate;
   445	
   446	            const passwordStatus = affiliate.passwordChanged ? '<span class="text-green-600"><i class="fas fa-check-circle mr-2"></i>Senha j√° foi alterada</span>' : '<span class="text-yellow-600"><i class="fas fa-exclamation-triangle mr-2"></i>Senha padr√£o (n√£o alterada)</span>';
   447	
   448	            document.getElementById('login-info').innerHTML = '<div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 rounded-xl"><div class="flex items-center space-x-3 mb-3"><div class="bg-white text-blue-600 w-12 h-12 rounded-full flex items-center justify-center text-lg font-bold">' + affiliate.name.charAt(0).toUpperCase() + '</div><div><h4 class="text-lg font-bold">' + affiliate.name + '</h4><p class="opacity-90 text-sm">' + affiliate.email + '</p></div></div></div><div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-4 mt-4"><h5 class="text-base font-bold text-gray-800 mb-3"><i class="fas fa-key text-blue-600 mr-2"></i>Credenciais de Login</h5><div class="space-y-2"><div class="bg-white p-3 rounded-lg border border-gray-200"><label class="block text-xs font-bold text-gray-600 mb-1">USU√ÅRIO</label><div class="flex items-center justify-between"><span class="text-base font-bold text-gray-800">' + (affiliate.username || 'N√£o gerado') + '</span><button onclick="copyToClipboard(\'' + affiliate.username + '\')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition"><i class="fas fa-copy"></i></button></div></div><div class="bg-white p-3 rounded-lg border border-gray-200"><label class="block text-xs font-bold text-gray-600 mb-1">SENHA</label><div class="flex items-center justify-between"><span class="text-base font-bold text-gray-800 font-mono">' + (affiliate.password || 'N√£o gerada') + '</span><button onclick="copyToClipboard(\'' + affiliate.password + '\')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition"><i class="fas fa-copy"></i></button></div></div><div class="bg-white p-3 rounded-lg border border-gray-200"><label class="block text-xs font-bold text-gray-600 mb-1">LINK</label><div class="flex items-center justify-between gap-2"><span class="text-xs text-blue-600 truncate">https://kainow.com.br/afiliado/login.html</span><button onclick="copyToClipboard(\'https://kainow.com... (line truncated)
   449	            
   450	            document.getElementById('login-modal').classList.remove('hidden');
   451	        }
   452	
   453	        // Fechar modal de login
   454	        function closeLoginModal() {
   455	            document.getElementById('login-modal').classList.add('hidden');
   456	            currentAffiliate = null;
   457	        }
   458	
   459	        // Copiar para √°rea de transfer√™ncia
   460	        function copyToClipboard(text) {
   461	            if (navigator.clipboard) {
   462	                navigator.clipboard.writeText(text).then(() => {
   463	                    alert('‚úÖ Copiado para √°rea de transfer√™ncia!');
   464	                }).catch(err => {
   465	                    alert('‚ùå Erro ao copiar: ' + err);
   466	                });
   467	            } else {
   468	                const textarea = document.createElement('textarea');
   469	                textarea.value = text;
   470	                document.body.appendChild(textarea);
   471	                textarea.select();
   472	                document.execCommand('copy');
   473	                document.body.removeChild(textarea);
   474	                alert('‚úÖ Copiado!');
   475	            }
   476	        }
   477	
   478	        // Copiar todas as credenciais
   479	        function copyLoginCredentials() {
   480	            if (!currentAffiliate) return;
   481	            const text = 'üîê CREDENCIAIS DE ACESSO\n\nüë§ Usu√°rio: ' + currentAffiliate.username + '\nüîë Senha: ' + currentAffiliate.password + '\nüåê Link: https://kainow.com.br/afiliado/login.html';
   482	            copyToClipboard(text);
   483	        }
   484	
   485	        // Enviar via WhatsApp
   486	        function sendWhatsApp() {
   487	            if (!currentAffiliate) return;
   488	            const message = 'üéâ Ol√° ' + currentAffiliate.name + '!\n\nVoc√™ foi cadastrado como divulgador da KaiNow Sa√∫de!\n\nüîê CREDENCIAIS DE ACESSO:\nüë§ Usu√°rio: ' + currentAffiliate.username + '\nüîë Senha: ' + currentAffiliate.password + '\n\nüåê Acesse seu painel:\nhttps://kainow.com.br/afiliado/login.html\n\nüí∞ Sua comiss√£o: ' + currentAffiliate.commission + '%\nüí≥ Recebimento PIX: ' + (currentAffiliate.pixKey || 'A cadastrar') + '\n\n‚ö†Ô∏è IMPORTANTE: Troque sua senha no primeiro acesso!\n\nQualquer d√∫vida, estou √† disposi√ß√£o! üòä';
   489	            const phone = currentAffiliate.phone.replace(/\D/g, '');
   490	            const whatsappUrl = 'https://wa.me/55' + phone + '?text=' + encodeURIComponent(message);
   491	            window.open(whatsappUrl, '_blank');
   492	        }
   493	
   494	        // Mostrar links do afiliado
   495	        async function showLinks(affiliateId) {
   496	            const affiliates = await loadAffiliates();
   497	            const affiliate = affiliates.find(a => a.id === affiliateId);
   498	            if (!affiliate) return;
   499	
   500	            document.getElementById('affiliate-info').innerHTML = '<div class="flex justify-between items-start"><div><h4 class="text-lg font-bold">' + affiliate.name + '</h4><p class="opacity-90 mb-2 text-sm">' + affiliate.email + '</p></div><div class="text-right"><p class="text-2xl font-black">' + affiliate.commission + '%</p><p class="text-xs opacity-90">comiss√£o</p></div></div>';
   501	
   502	            const linksHtml = products.map(product => {
   503	                const refParam = affiliate.slug || affiliate.username;
   504	                const affiliateLink = 'https://kainow.com.br/programa-' + product.id + '.html?ref=' + refParam;
   505	                const divulgadorValor = (parseFloat(product.price.replace(',', '.')) * affiliate.commission / 100).toFixed(2).replace('.', ',');
   506	                const plataformaValor = (parseFloat(product.price.replace(',', '.')) * (100 - affiliate.commission) / 100).toFixed(2).replace('.', ',');
   507	                
   508	                return '<div class="border-2 border-gray-200 bg-gray-50 rounded-xl p-4"><div class="flex items-center mb-3"><div class="bg-blue-600 rounded-full w-10 h-10 flex items-center justify-center text-white mr-3 text-sm"><i class="fas ' + product.icon + '"></i></div><div><h5 class="text-base font-bold text-gray-800">' + product.name + '</h5><p class="text-sm text-gray-600">R$ ' + product.price + '/m√™s</p></div></div><div class="bg-white p-3 rounded-lg mb-2"><p class="text-xs text-gray-600 mb-1 font-bold">Link:</p><div class="flex items-center gap-2"><input type="text" value="' + affiliateLink + '" readonly class="flex-1 px-2 py-1.5 bg-gray-50 border border-gray-300 rounded text-xs" id="link-' + product.id + '-' + affiliateId + '"><button onclick="copyLink(\'link-' + product.id + '-' + affiliateId + '\')" class="bg-blue-600 text-white px-3 py-1.5 rounded hover:bg-opacity-90 transition text-xs"><i class="fas fa-copy"></i></button></div></div><div class="grid grid-cols-2 gap-2"><div class="bg-green-100 p-2 rounded-lg"><p class="text-xs text-gray-700 mb-0.5"><i class="fab fa-pix mr-1"></i>Divulgador</p><p class="text-base font-bold text-green-700">R$ ' + divulgadorValor + '</p>' + (affiliate.pixKey ? '<p class="text-xs text-gray-600 mt-0.5 truncate">‚Ü™ ' + affiliate.pixKey + '</p>' : '') + '</div><div class="bg-purple-100 p-2 rounded-lg"><p class="text-xs text-gray-700 mb-0.5">Plataforma</p><p class="text-base font-bold text-purple-700">R$ ' + plataformaValor + '</p></div></div></div>';
   509	            }).join('');
   510	
   511	            document.getElementById('products-links').innerHTML = linksHtml;
   512	            document.getElementById('affiliate-links-modal').classList.remove('hidden');
   513	        }
   514	
   515	        // Fechar modal de links
   516	        function closeLinksModal() {
   517	            document.getElementById('affiliate-links-modal').classList.add('hidden');
   518	        }
   519	
   520	        // Copiar link
   521	        function copyLink(inputId) {
   522	            const input = document.getElementById(inputId);
   523	            input.select();
   524	            document.execCommand('copy');
   525	            alert('‚úÖ Link copiado para √°rea de transfer√™ncia!');
   526	        }
   527	
   528	        // Editar comiss√£o
   529	        async function editCommission(affiliateId) {
   530	            const affiliates = await loadAffiliates();
   531	            const affiliate = affiliates.find(a => a.id === affiliateId);
   532	            if (!affiliate) return;
   533	
   534	            const currentPix = affiliate.pixKey || 'N√£o cadastrado';
   535	            const editData = prompt('üìù EDITAR AFILIADO: ' + affiliate.name + '\n\nüí∞ Comiss√£o atual: ' + affiliate.commission + '%\nüí≥ PIX atual: ' + currentPix + '\n\nDigite a nova comiss√£o (0-100):', affiliate.commission);
   536	
   537	            if (editData === null) return;
   538	
   539	            const commission = parseInt(editData);
   540	
   541	            if (isNaN(commission) || commission < 0 || commission > 100) {
   542	                alert('‚ùå Comiss√£o inv√°lida! Digite um valor entre 0 e 100.');
   543	                return;
   544	            }
   545	
   546	            const updatePix = confirm('üí≥ Deseja atualizar a chave PIX tamb√©m?');
   547	            
   548	            if (updatePix) {
   549	                const newPixKey = prompt('üí≥ PIX atual: ' + currentPix + '\n\nDigite a nova chave PIX:', affiliate.pixKey || '');
   550	                
   551	                if (newPixKey && newPixKey.trim() !== '') {
   552	                    affiliate.pixKey = newPixKey.trim();
   553	                    
   554	                    const pixType = prompt('üì± Selecione o tipo de chave PIX:\n\n1 - CPF\n2 - CNPJ\n3 - Email\n4 - Telefone\n5 - Chave Aleat√≥ria\n\nDigite o n√∫mero:', '1');
   555	                    
   556	                    const pixTypes = {
   557	                        '1': 'cpf',
   558	                        '2': 'cnpj',
   559	                        '3': 'email',
   560	                        '4': 'telefone',
   561	                        '5': 'aleatoria'
   562	                    };
   563	                    
   564	                    affiliate.pixType = pixTypes[pixType] || 'cpf';
   565	                }
   566	            }
   567	
   568	            try {
   569	                const updateData = { commission: commission };
   570	                
   571	                if (updatePix && affiliate.pixKey) {
   572	                    updateData.pixKey = affiliate.pixKey;
   573	                    updateData.pixType = affiliate.pixType || 'cpf';
   574	                }
   575	                
   576	                console.log('üìù Atualizando afiliado:', affiliateId, updateData);
   577	                await db.collection('affiliates').doc(affiliateId).update(updateData);
   578	                
   579	                alert('‚úÖ Afiliado atualizado com sucesso!');
   580	                await updateStats();
   581	                await renderAffiliates();
   582	            } catch (error) {
   583	                console.error('‚ùå Erro ao atualizar:', error);
   584	                alert('‚ùå Erro ao atualizar afiliado: ' + error.message);
   585	            }
   586	        }
   587	
   588	        // Excluir afiliado
   589	        async function deleteAffiliate(affiliateId) {
   590	            if (!confirm('Tem certeza que deseja excluir este divulgador?')) return;
   591	
   592	            try {
   593	                console.log('üóëÔ∏è Deletando afiliado:', affiliateId);
   594	                await db.collection('affiliates').doc(affiliateId).delete();
   595	                alert('‚úÖ Divulgador exclu√≠do com sucesso!');
   596	                await updateStats();
   597	                await renderAffiliates();
   598	            } catch (error) {
   599	                console.error('‚ùå Erro ao deletar:', error);
   600	                alert('‚ùå Erro ao excluir divulgador: ' + error.message);
   601	            }
   602	        }
   603	
   604	        // Logout
   605	        function logout() {
   606	            if (confirm('Deseja sair do painel administrativo?')) {
   607	                localStorage.removeItem('kainow_admin_session');
   608	                sessionStorage.removeItem('kainow_admin_session');
   609	                window.location.href = 'login-admin.html';
   610	            }
   611	        }
   612	
   613	        // Preview do slug em tempo real
   614	        document.getElementById('affiliate-slug').addEventListener('input', function(e) {
   615	            let slug = e.target.value.toLowerCase().trim();
   616	            slug = slug.replace(/[^a-z0-9-]/g, '');
   617	            e.target.value = slug;
   618	            
   619	            const preview = document.getElementById('slug-preview');
   620	            if (slug) {
   621	                preview.textContent = slug;
   622	                preview.classList.remove('text-gray-400');
   623	                preview.classList.add('text-blue-600', 'font-bold');
   624	            } else {
   625	                preview.textContent = 'seu-nome';
   626	                preview.classList.add('text-gray-400');
   627	                preview.classList.remove('text-blue-600', 'font-bold');
   628	            }
   629	        });
   630	
   631	        // Inicializar
   632	        updateStats();
   633	        renderAffiliates();
   634	        
   635	        console.log('üöÄ Gerenciador de Afiliados v3.1 carregado!');
   636	        console.log('üìÖ Timestamp:', new Date().toISOString());
   637	        
   638	        const versionBanner = document.createElement('div');
   639	        versionBanner.className = 'fixed top-20 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-2xl z-50';
   640	        versionBanner.innerHTML = '<div class="flex items-center space-x-3"><i class="fas fa-check-circle text-2xl"></i><div><p class="font-bold">Vers√£o 3.1 Carregada!</p><p class="text-xs">Salva no Firebase ‚úÖ</p></div></div>';
   641	        document.body.appendChild(versionBanner);
   642	        setTimeout(() => versionBanner.remove(), 5000);
   643	
   644	        window.addEventListener('DOMContentLoaded', async function() {
   645	            console.log('üöÄ P√°gina carregada, buscando afiliados do Firestore...');
   646	            await updateStats();
   647	            await renderAffiliates();
   648	        });
   649	    </script>
   650	    
   651	    <script src="../js/admin-auth.js"></script>
   652	    <script type="text/javascript">
   653	        checkAdminAuth();
   654	    </script>
   655	</body>
   656	</html>
   657	
