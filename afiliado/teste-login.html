<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Login - gelcisilva252</title>
    <style>
        body {
            font-family: monospace;
            background: #000;
            color: #0f0;
            padding: 20px;
            line-height: 1.8;
        }
        .log { padding: 10px; margin: 5px 0; border-left: 4px solid #0f0; }
        .error { color: #f00; border-color: #f00; }
        .success { color: #0f0; border-color: #0f0; }
        .info { color: #0ff; border-color: #0ff; }
        .warning { color: #ff0; border-color: #ff0; }
        button { 
            background: #0f0; 
            color: #000; 
            border: none; 
            padding: 15px 30px; 
            font-size: 18px; 
            font-weight: bold; 
            cursor: pointer; 
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ” TESTE DE LOGIN - gelcisilva252</h1>
    <div id="output"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        const output = document.getElementById('output');

        function log(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = 'log ' + type;
            div.textContent = msg;
            output.appendChild(div);
        }

        async function testar() {
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            log('ğŸ” TESTE DE LOGIN - gelcisilva252', 'info');
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');

            // 1. Verificar sessÃ£o
            log('\n[1/4] Verificando sessÃ£o...', 'info');
            const sessionLS = localStorage.getItem('kainow_affiliate_session');
            const sessionSS = sessionStorage.getItem('kainow_affiliate_session');
            
            if (!sessionLS && !sessionSS) {
                log('âŒ NENHUMA SESSÃƒO ENCONTRADA!', 'error');
                log('VocÃª precisa fazer login primeiro em: afiliado/login.html', 'warning');
                return;
            }

            const session = JSON.parse(sessionLS || sessionSS);
            log('âœ… SessÃ£o encontrada!', 'success');
            log('Username: ' + session.username, 'success');
            log('Nome: ' + session.name, 'success');
            log('Email: ' + session.email, 'success');

            // 2. Configurar Firebase
            log('\n[2/4] Configurando Firebase...', 'info');
            const config = {
                apiKey: "AIzaSyA2-tCGH1uaABTzMqhK_BhTy-zIZba0wMs",
                authDomain: "kainowsaude.firebaseapp.com",
                projectId: "kainowsaude",
                storageBucket: "kainowsaude.firebasestorage.app",
                messagingSenderId: "230049250523",
                appId: "1:230049250523:web:ce16ada5c4e5488e64e0fe"
            };
            firebase.initializeApp(config);
            const db = firebase.firestore();
            log('âœ… Firebase configurado!', 'success');

            // 3. Buscar no Firestore
            log('\n[3/4] Buscando no Firestore...', 'info');
            log('Buscando por username: "' + session.username + '"', 'info');

            try {
                const query = db.collection('affiliates')
                    .where('username', '==', session.username)
                    .limit(1);
                
                const snapshot = await query.get();
                
                log('Query executada!', 'info');
                log('Documentos encontrados: ' + snapshot.size, 'info');
                log('EstÃ¡ vazio? ' + (snapshot.empty ? 'SIM' : 'NÃƒO'), 'info');

                if (snapshot.empty) {
                    log('\nâŒ AFILIADO NÃƒO ENCONTRADO!', 'error');
                    log('O username "' + session.username + '" nÃ£o existe no Firestore.', 'error');
                    
                    // Listar todos
                    log('\n[EXTRA] Listando TODOS os afiliados...', 'warning');
                    const all = await db.collection('affiliates').get();
                    log('Total de afiliados no Firestore: ' + all.size, 'warning');
                    
                    if (all.size > 0) {
                        log('\nUsernames no Firestore:', 'warning');
                        all.forEach((doc, i) => {
                            const d = doc.data();
                            log((i+1) + '. "' + d.username + '" - ' + d.name, 'warning');
                        });
                    }
                    
                    log('\nğŸ”§ PROBLEMA: Username na sessÃ£o Ã© diferente do Firestore!', 'error');
                    
                } else {
                    log('\nâœ… AFILIADO ENCONTRADO!', 'success');
                    const doc = snapshot.docs[0];
                    const data = doc.data();
                    
                    log('\nğŸ“„ DADOS DO FIRESTORE:', 'success');
                    log('ID: ' + doc.id, 'success');
                    log('Username: ' + data.username, 'success');
                    log('Senha: ' + data.password, 'success');
                    log('Nome: ' + data.name, 'success');
                    log('Email: ' + data.email, 'success');
                    log('ComissÃ£o: ' + data.commission + '%', 'success');
                    log('Ativo: ' + (data.active ? 'Sim' : 'NÃ£o'), 'success');
                    
                    log('\nğŸ‰ TUDO CERTO! O dashboard deve funcionar!', 'success');
                }

            } catch (error) {
                log('\nâŒ ERRO AO BUSCAR:', 'error');
                log('Mensagem: ' + error.message, 'error');
                log('CÃ³digo: ' + error.code, 'error');
                
                if (error.code === 'permission-denied') {
                    log('\nğŸš¨ PROBLEMA: PermissÃµes do Firestore bloqueadas!', 'error');
                }
            }

            // 4. ConclusÃ£o
            log('\n[4/4] ConclusÃ£o', 'info');
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
        }

        testar();
    </script>
</body>
</html>
