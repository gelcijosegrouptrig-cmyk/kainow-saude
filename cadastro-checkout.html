                const clientData = {
                    nome: document.getElementById('nome').value.trim(),
                    email: document.getElementById('email').value.trim().toLowerCase(),
                    cpf: document.getElementById('cpf').value.trim(),
                    telefone: document.getElementById('telefone').value.trim(),
                    dataNascimento: document.getElementById('dataNascimento').value,
                    senha: senhaHash,
                    
                    programa: programId,
                    programaNome: currentProgram.name,
                    valorMensal: currentProgram.price,
                    
                    indicadoPor: affiliateRef || null,
                    afiliado: affiliateData ? {
                        username: affiliateData.username,
                        nome: affiliateData.name,
                        comissao: affiliateData.commission || 20,
                        pixKey: affiliateData.pixKey
                    } : null,

                    status: 'aguardando_pagamento',
                    dataCadastro: firebase.firestore.FieldValue.serverTimestamp(),
                    pagamentoId: null,
                    dataPagamento: null
                };

                console.log('üìù Salvando cliente (senha com hash):', { ...clientData, senha: '[HASH PROTEGIDO]' });

                // Salvar no Firestore
                const docRef = await db.collection('clientes').add(clientData);
                console.log('‚úÖ Cliente cadastrado! ID:', docRef.id);

                // Salvar ID do cliente na sess√£o
                sessionStorage.setItem('kainow_client_id', docRef.id);
                sessionStorage.setItem('kainow_client_data', JSON.stringify(clientData));

                // ‚úÖ CRIAR COBRAN√áA COM SPLIT WOOVI
                if (affiliateRef && affiliateData) {
                    console.log('üí∞ Criando cobran√ßa com split 80/20...');
                    
                    try {
                        const BACKEND_URL = 'https://kainow-saude-production.up.railway.app';
                        const valueInCents = Math.round(currentProgram.price * 100);
                        
                        const chargeData = {
                            productId: programId,
                            value: valueInCents,
                            affiliateId: affiliateRef,
                            customerName: clientData.nome,
                            customerEmail: clientData.email,
                            customerPhone: clientData.telefone
                        };
                        
                        console.log('üì§ Enviando para API:', chargeData);
                        
                        const response = await fetch(`${BACKEND_URL}/api/charges/create-with-split`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(chargeData)
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || 'Erro ao criar cobran√ßa');
                        }
                        
                        const result = await response.json();
                        console.log('‚úÖ Cobran√ßa criada com sucesso!');
                        console.log('üí∞ Split:', result.charge.split);
                        
                        // Salvar dados da cobran√ßa no documento do cliente
                        await db.collection('clientes').doc(docRef.id).update({
                            pagamentoId: result.charge.id,
                            qrCode: result.charge.qrCode,
                            qrCodeText: result.charge.qrCodeText,
                            paymentLink: result.charge.paymentLink,
                            splitInfo: result.charge.split
                        });
                        
                        // Salvar no localStorage para p√°gina de pagamento
                        localStorage.setItem('kainow_current_charge', JSON.stringify({
                            chargeId: result.charge.id,
                            clientId: docRef.id,
                            productId: programId,
                            productName: currentProgram.name,
                            value: valueInCents,
                            qrCode: result.charge.qrCode,
                            qrCodeText: result.charge.qrCodeText,
                            paymentLink: result.charge.paymentLink,
                            affiliateId: affiliateRef,
                            affiliateName: affiliateData.name,
                            split: result.charge.split
                        }));
                        
                        console.log('‚úÖ Dados salvos! Redirecionando...');
                        window.location.href = 'pagamento-pix.html';
                        
                    } catch (errorCharge) {
                        console.error('‚ùå Erro ao criar cobran√ßa:', errorCharge);
                        alert('‚ùå Erro ao gerar PIX. Tente novamente.');
                        
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Continuar para Pagamento';
                    }
                } else {
                    console.log('üìù Sem afiliado, redirecionando para pagamento padr√£o');
                    window.location.href = `pagamento-pix.html?client=${docRef.id}&program=${programId}`;
                }

            } catch (error) {
                console.error('‚ùå Erro ao cadastrar:', error);
                alert('‚ùå Erro ao processar cadastro: ' + error.message);
                
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Continuar para Pagamento';
            }
        });

    </script>
</body>
</html>
