<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro - KaiNow Sa√∫de</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- bcrypt.js -->
    <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-4">
            <h1 class="text-2xl font-bold text-blue-600">
                <i class="fas fa-heartbeat mr-2"></i>
                KaiNow Sa√∫de - Cadastro
            </h1>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8 max-w-2xl">
        <div class="bg-white rounded-xl shadow-lg p-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Complete seu Cadastro</h2>

            <!-- Status Messages -->
            <div id="status-message" class="hidden mb-6 p-4 rounded-lg"></div>

            <form id="registration-form" class="space-y-6">
                <!-- Nome Completo -->
                <div>
                    <label for="nome" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-user mr-2"></i>Nome Completo *
                    </label>
                    <input 
                        type="text" 
                        id="nome" 
                        name="nome" 
                        required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Seu nome completo"
                    >
                </div>

                <!-- Email -->
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-envelope mr-2"></i>Email *
                    </label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="seu@email.com"
                    >
                </div>

                <!-- CPF -->
                <div>
                    <label for="cpf" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-id-card mr-2"></i>CPF *
                    </label>
                    <input 
                        type="text" 
                        id="cpf" 
                        name="cpf" 
                        required
                        maxlength="14"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="000.000.000-00"
                    >
                </div>

                <!-- Telefone -->
                <div>
                    <label for="telefone" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-phone mr-2"></i>Telefone/WhatsApp *
                    </label>
                    <input 
                        type="tel" 
                        id="telefone" 
                        name="telefone" 
                        required
                        maxlength="15"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="(00) 00000-0000"
                    >
                </div>

                <!-- Senha -->
                <div>
                    <label for="senha" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-lock mr-2"></i>Senha *
                    </label>
                    <input 
                        type="password" 
                        id="senha" 
                        name="senha" 
                        required
                        minlength="6"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="M√≠nimo 6 caracteres"
                    >
                    <p class="text-xs text-gray-500 mt-1">Use para acessar sua √°rea de cliente</p>
                </div>

                <!-- Confirmar Senha -->
                <div>
                    <label for="confirmar-senha" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-lock mr-2"></i>Confirmar Senha *
                    </label>
                    <input 
                        type="password" 
                        id="confirmar-senha" 
                        name="confirmar-senha" 
                        required
                        minlength="6"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Digite a senha novamente"
                    >
                </div>

                <!-- Programa (hidden) -->
                <input type="hidden" id="programa" name="programa">
                <input type="hidden" id="programaNome" name="programaNome">
                <input type="hidden" id="valorMensal" name="valorMensal">

                <!-- Afiliado (se houver) -->
                <div id="affiliate-info" style="display:none;" class="bg-green-50 border-l-4 border-green-500 p-4 rounded">
                    <p class="text-green-800 font-bold">
                        <i class="fas fa-user-check mr-2"></i>
                        Indicado por: <span id="affiliate-name-display">Carregando...</span>
                    </p>
                    <p class="text-green-700 text-sm">Voc√™ e seu indicador ganham benef√≠cios!</p>
                </div>

                <!-- Bot√£o Submit -->
                <button 
                    type="submit" 
                    id="submit-btn"
                    class="w-full bg-blue-600 text-white py-4 rounded-lg font-bold text-lg hover:bg-blue-700 transition duration-300 shadow-lg"
                >
                    <i class="fas fa-check-circle mr-2"></i>
                    Finalizar Cadastro
                </button>

                <p class="text-xs text-gray-500 text-center">
                    Ao cadastrar voc√™ concorda com nossos <a href="#" class="text-blue-600">Termos de Uso</a> e <a href="#" class="text-blue-600">Pol√≠tica de Privacidade</a>
                </p>
            </form>
        </div>
    </div>

    <script>
        // Configura√ß√£o Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA2-tCGH1uaABTzMqhK_BhTy-zIZba0wMs",
            authDomain: "kainowsaude.firebaseapp.com",
            projectId: "kainowsaude",
            storageBucket: "kainowsaude.firebasestorage.app",
            messagingSenderId: "230049250523",
            appId: "1:230049250523:web:ce16ada5c4e5488e64e0fe"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Obter par√¢metros da URL
        const urlParams = new URLSearchParams(window.location.search);
        const programParam = urlParams.get('program');
        const affiliateRef = urlParams.get('ref');

        console.log('üìã Par√¢metros recebidos:', { program: programParam, ref: affiliateRef });

        // Informa√ß√µes dos programas
        const programsInfo = {
            'saude-mulher': { name: 'Sa√∫de da Mulher', price: 49.90 },
            'senior-plus': { name: 'S√™nior Plus', price: 79.90 },
            'farma-acesso': { name: 'Farma Acesso', price: 59.90 },
            'acolher': { name: 'Acolher', price: 39.90 },
            'orienta': { name: 'Orienta', price: 34.90 },
            'viva-leve': { name: 'Viva Leve', price: 44.90 }
        };

        // Definir programa
        if (programParam && programsInfo[programParam]) {
            const program = programsInfo[programParam];
            document.getElementById('programa').value = programParam;
            document.getElementById('programaNome').value = program.name;
            document.getElementById('valorMensal').value = program.price;
            console.log('‚úÖ Programa definido:', program);
        } else {
            console.warn('‚ö†Ô∏è Programa n√£o encontrado, usando padr√£o');
            document.getElementById('programa').value = 'saude-mulher';
            document.getElementById('programaNome').value = 'Sa√∫de da Mulher';
            document.getElementById('valorMensal').value = '49.90';
        }

        // Buscar dados do afiliado
        let affiliateData = null;

        if (affiliateRef) {
            console.log('üîç Buscando afiliado:', affiliateRef);
            
            db.collection('affiliates').where('username', '==', affiliateRef).get()
                .then(snapshot => {
                    if (!snapshot.empty) {
                        affiliateData = snapshot.docs[0].data();
                        affiliateData.id = snapshot.docs[0].id;
                        
                        console.log('‚úÖ Afiliado encontrado:', affiliateData);
                        
                        // Exibir informa√ß√£o do afiliado
                        document.getElementById('affiliate-info').style.display = 'block';
                        document.getElementById('affiliate-name-display').textContent = affiliateData.nome || affiliateData.username;
                    } else {
                        console.warn('‚ö†Ô∏è Afiliado n√£o encontrado:', affiliateRef);
                    }
                })
                .catch(error => {
                    console.error('‚ùå Erro ao buscar afiliado:', error);
                });
        }

        // M√°scaras de formata√ß√£o
        document.getElementById('cpf').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            }
            e.target.value = value;
        });

        document.getElementById('telefone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                value = value.replace(/(\d{2})(\d)/, '($1) $2');
                value = value.replace(/(\d{5})(\d)/, '$1-$2');
            }
            e.target.value = value;
        });

        // Status message helper
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = `mb-6 p-4 rounded-lg ${type === 'success' ? 'bg-green-100 text-green-800 border border-green-300' : 'bg-red-100 text-red-800 border border-red-300'}`;
            statusDiv.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}-circle mr-2"></i>${message}`;
            statusDiv.classList.remove('hidden');
        }

        // Fun√ß√£o de hash de senha com fallback
        async function hashPassword(password) {
            try {
                if (typeof bcrypt !== 'undefined' && bcrypt.hashSync) {
                    console.log('üîê Usando bcrypt para hash');
                    return bcrypt.hashSync(password, 10);
                } else {
                    console.warn('‚ö†Ô∏è bcrypt n√£o dispon√≠vel, usando hash simples');
                    return 'simple_' + btoa(password);
                }
            } catch (error) {
                console.error('‚ùå Erro ao fazer hash:', error);
                return 'simple_' + btoa(password);
            }
        }

        // Submit do formul√°rio
        document.getElementById('registration-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Salvando...';

            try {
                // Validar senhas
                const senha = document.getElementById('senha').value;
                const confirmarSenha = document.getElementById('confirmar-senha').value;

                if (senha !== confirmarSenha) {
                    showStatus('As senhas n√£o coincidem!', 'error');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Finalizar Cadastro';
                    return;
                }

                // Hash da senha
                const senhaHash = await hashPassword(senha);

                // Preparar dados do cliente
                const clientData = {
                    nome: document.getElementById('nome').value,
                    email: document.getElementById('email').value,
                    cpf: document.getElementById('cpf').value,
                    telefone: document.getElementById('telefone').value,
                    senhaHash: senhaHash,
                    programa: document.getElementById('programa').value,
                    programaNome: document.getElementById('programaNome').value,
                    valorMensal: parseFloat(document.getElementById('valorMensal').value),
                    status: 'pendente',
                    criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
                    indicadoPor: affiliateRef || null
                };

                // Adicionar dados do afiliado se houver
                if (affiliateData) {
                    clientData.afiliado = {
                        id: affiliateData.id,
                        username: affiliateData.username,
                        nome: affiliateData.nome || affiliateData.username,
                        cpf: affiliateData.cpf || null,
                        pixKey: affiliateData.pixKey || null,
                        comissao: affiliateData.comissao || 20
                    };
                }

                console.log('üíæ Salvando cliente:', clientData);

                // Salvar no Firestore
                const docRef = await db.collection('clientes').add(clientData);
                
                console.log('‚úÖ Cliente salvo com ID:', docRef.id);

                showStatus('Cadastro realizado com sucesso! Redirecionando...', 'success');

               const paymentUrl = `pagamento.html?client=${docRef.id}&program=${clientData.programa}${affiliateRef ? '&ref=' + affiliateRef : ''}`;
            } catch (error) {
                console.error('‚ùå Erro ao salvar:', error);
                showStatus('Erro ao salvar cadastro: ' + error.message, 'error');
                
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Finalizar Cadastro';
            }
        });
    </script>
</body>
</html>